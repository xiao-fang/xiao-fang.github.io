<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>xiao-fang.cc</title>
  
  <subtitle>一粟生</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://xiao-fang.cc/"/>
  <updated>2020-11-16T01:47:12.577Z</updated>
  <id>http://xiao-fang.cc/</id>
  
  <author>
    <name>xiao-fang</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Quick Start A Local-Hosted K8S Environment</title>
    <link href="http://xiao-fang.cc/2020/10/20/local-k8s-minikube/"/>
    <id>http://xiao-fang.cc/2020/10/20/local-k8s-minikube/</id>
    <published>2020-10-20T00:00:00.000Z</published>
    <updated>2020-11-16T01:47:12.577Z</updated>
    
    <content type="html"><![CDATA[<!-- Quick Start A Local-Hosted K8S Environment --><p><em>Kubernetes</em> (K8S) is an open-source system for automating deployment, scaling, and management of containerized applications, which is now graduated from <a href="https://www.cncf.io/" target="_blank" rel="noopener">CNCF</a>. </p><p>All cloud service providers like AWS, Azure, Aliyun, Tecent Cloud are now providing cloud-based and easy-to-use K8S infrastructure.</p><p>Here uses <a href="https://minikube.sigs.k8s.io/docs/start/" target="_blank" rel="noopener">minikue</a> to quick start a new local K8S environment for development.</p><p><img src="https://raw.githubusercontent.com/kubernetes/kubernetes/587d164307de060d271f10f2386f39153360fba9/docs/design/architecture.svg" alt="K8S Architecture"></p><h2><span id="requirements">Requirements</span></h2><p><code>Minikube</code> supports container or virtual machine manager, such as <a href="https://minikube.sigs.k8s.io/docs/start/#what-youll-need" target="_blank" rel="noopener">Docker, Hyperkit, Hyper-V, KVM, Parallels, Podman, VirtualBox, or VMWare</a>. </p><p>I start from CentOS 7 VM (<em>2+ cpu, 4GB memory, 20+GB disk</em>).</p><ul><li><p>Install <code>Docker</code> </p><ul><li>refer to <a href="https://docs.docker.com/engine/install/centos/" target="_blank" rel="noopener">Install Docker Engine on CentOS</a></li></ul></li><li><p>Install Kubectl</p><ul><li>refer to <a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/" target="_blank" rel="noopener">Install and Set Up kubectl</a></li></ul></li><li><p>Install minikube</p><ul><li>refer to <a href="https://minikube.sigs.k8s.io/docs/start/" target="_blank" rel="noopener">minikube start</a></li></ul></li></ul><a id="more"></a><h2><span id="start-a-new-cluster">Start a new cluster</span></h2><p>From a terminal with administrator access (but not logged in as root), run <code>minikube start</code>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ minikube start</span><br><span class="line">* minikube v1.14.0 on Centos 7.8.2003</span><br><span class="line">* Automatically selected the docker driver</span><br><span class="line">* Starting control plane node minikube <span class="keyword">in</span> cluster minikube</span><br><span class="line">* Creating docker container (CPUs=2, Memory=2200MB) ...</span><br><span class="line">* Preparing Kubernetes v1.19.2 on Docker 19.03.8 ...</span><br><span class="line">* Verifying Kubernetes components...</span><br><span class="line">* Enabled addons: default-storageclass, storage-provisioner</span><br><span class="line">* Done! kubectl is now configured to use <span class="string">"minikube"</span> by default</span><br></pre></td></tr></table></figure><p>if run as <code>root</code>, will throw following error:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># minikube start</span></span><br><span class="line">* minikube v1.14.0 on Centos 7.8.2003</span><br><span class="line">* Automatically selected the docker driver</span><br><span class="line">* The <span class="string">"docker"</span> driver should not be used with root privileges.</span><br><span class="line">* If you are running minikube within a VM, consider using --driver=none:</span><br><span class="line">*   https://minikube.sigs.k8s.io/docs/reference/drivers/none/</span><br><span class="line"></span><br><span class="line">X Exiting due to DRV_AS_ROOT: The <span class="string">"docker"</span> driver should not be used with root privileges.</span><br></pre></td></tr></table></figure><p>After <code>minikube start</code>, let’s check <code>minikube status</code>:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ minikube status</span><br><span class="line">minikube</span><br><span class="line"><span class="built_in">type</span>: Control Plane</span><br><span class="line">host: Running</span><br><span class="line">kubelet: Running</span><br><span class="line">apiserver: Running</span><br><span class="line">kubeconfig: Configured</span><br></pre></td></tr></table></figure></p><p>What happens behind? <code>minikube start</code>s a new docker container named <em>minikube</em> from image <code>gcr.io/k8s-minikube/kicbase:v0.0.13</code>. the <em>minikube</em> container is the only one <code>node</code> of current K8S cluster. </p><p>Deep dive into the <code>minikube</code> container, actually it’s also a docker environment runs a minimal set components (as containers/<code>pods</code>) of k8s cluster <strong>inside</strong>, like <em>controller manager, scheduler, etcd, apiserver, proxy, coredns, storage provisioner, metric scraper, dashboard, etc</em> (refer to above <em>K8S Architecture</em>).</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># following scripts to see k8s inside, not neccessary steps to start a k8s cluster</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># minikube start a new container named minikube</span></span><br><span class="line">$ docker ps</span><br><span class="line">CONTAINER ID        IMAGE                                 COMMAND                  CREATED             STATUS              PORTS                                                                                                      NAMES</span><br><span class="line">22353255b3d8        gcr.io/k8s-minikube/kicbase:v0.0.13   <span class="string">"/usr/local/bin/entr…"</span>   5 minutes ago       Up 5 minutes        127.0.0.1:32779-&gt;22/tcp, 127.0.0.1:32778-&gt;2376/tcp, 127.0.0.1:32777-&gt;5000/tcp, 127.0.0.1:32776-&gt;8443/tcp   minikube</span><br><span class="line"></span><br><span class="line"><span class="comment"># the minikube is the only one node of current K8S cluster</span></span><br><span class="line">$ kubectl get no -A</span><br><span class="line">NAME       STATUS   ROLES    AGE     VERSION</span><br><span class="line">minikube   Ready    master   6m18s   v1.19.2</span><br><span class="line"></span><br><span class="line"><span class="comment"># dive into the minikube container, actually there are a minimal components of k8s cluster, like,</span></span><br><span class="line"><span class="comment"># controller manager, scheduler, etcd, apiserver, proxy, coredns, storage provisioner, metric scraper, dashboard, etc.</span></span><br><span class="line">$ docker <span class="built_in">exec</span> -it minikube bash</span><br><span class="line"><span class="comment"># above equal to command 'minikube ssh' to login the minikube environment as docker user</span></span><br><span class="line">root@minikube:$ docker ps --format <span class="string">"table &#123;&#123;.ID&#125;&#125;\t&#123;&#123;.Image&#125;&#125;\t&#123;&#123;.Names&#125;&#125;"</span></span><br><span class="line">CONTAINER ID        IMAGE                  NAMES</span><br><span class="line">2c96ab880751        bad58561c4be           k8s_storage-provisioner_storage-provisioner_kube-system_f6123384-ac90-49cd-93e2-f99d9e243542_0</span><br><span class="line">c42638327a87        k8s.gcr.io/pause:3.2   k8s_POD_storage-provisioner_kube-system_f6123384-ac90-49cd-93e2-f99d9e243542_0</span><br><span class="line">d31089f8f566        bfe3a36ebd25           k8s_coredns_coredns-f9fd979d6-g8vjq_kube-system_cfe2bef7-f7a1-4aa4-9c93-1383d69c4293_0</span><br><span class="line">26f42373a94b        d373dd5a8593           k8s_kube-proxy_kube-proxy-rsw7l_kube-system_8ea9d442-8d6d-4c00-b272-df32d0fc3e5d_0</span><br><span class="line">7b94b2d4e6e5        k8s.gcr.io/pause:3.2   k8s_POD_coredns-f9fd979d6-g8vjq_kube-system_cfe2bef7-f7a1-4aa4-9c93-1383d69c4293_0</span><br><span class="line">dbabb0c1f811        k8s.gcr.io/pause:3.2   k8s_POD_kube-proxy-rsw7l_kube-system_8ea9d442-8d6d-4c00-b272-df32d0fc3e5d_0</span><br><span class="line">f6f333c19a28        607331163122           k8s_kube-apiserver_kube-apiserver-minikube_kube-system_f7c3d51df5e2ce4e433b64661ac4503c_0</span><br><span class="line">a0a8ee250949        0369cf4303ff           k8s_etcd_etcd-minikube_kube-system_d186e6390814d4dd7e770f47c08e98a2_0</span><br><span class="line">4940ac2f1f0c        2f32d66b884f           k8s_kube-scheduler_kube-scheduler-minikube_kube-system_ff7d12f9e4f14e202a85a7c5534a3129_0</span><br><span class="line">9815051dbc4b        8603821e1a7a           k8s_kube-controller-manager_kube-controller-manager-minikube_kube-system_dcc127c185c80a61d90d8e659e768641_0</span><br><span class="line">59b8793a0a3e        k8s.gcr.io/pause:3.2   k8s_POD_kube-apiserver-minikube_kube-system_f7c3d51df5e2ce4e433b64661ac4503c_0</span><br><span class="line">c0becce7b87d        k8s.gcr.io/pause:3.2   k8s_POD_etcd-minikube_kube-system_d186e6390814d4dd7e770f47c08e98a2_0</span><br><span class="line">49f74073f3f3        k8s.gcr.io/pause:3.2   k8s_POD_kube-scheduler-minikube_kube-system_ff7d12f9e4f14e202a85a7c5534a3129_0</span><br><span class="line">eaad3ec1c277        k8s.gcr.io/pause:3.2   k8s_POD_kube-controller-manager-minikube_kube-system_dcc127c185c80a61d90d8e659e768641_0</span><br></pre></td></tr></table></figure><blockquote><p>So we can have a quick view that <em>minikube</em> created a docker container with all neccessary k8s compoments inside, the container plays as the single <em>node</em> of k8s <em>cluster</em>.</p></blockquote><h2><span id="k8s-dashboard-and-proxy">K8S Dashboard and Proxy</span></h2><p><em>minikube</em> bundles the K8S <a href="https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/" target="_blank" rel="noopener">Dashboard</a>, a Web UI allows us to get easily management to the K8S enviroment:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># start a dashboard at backend</span></span><br><span class="line"><span class="comment"># it will try to open default brower</span></span><br><span class="line">minikube dashboard</span><br><span class="line">$ minikube dashboard &amp;</span><br><span class="line">* Enabling dashboard ...</span><br><span class="line">* Verifying dashboard health ...</span><br><span class="line">* Launching proxy ...</span><br><span class="line">* Verifying proxy health ...</span><br><span class="line">* Opening http://127.0.0.1:44278/api/v1/namespaces/kubernetes-dashboard/services/http:kubernetes-dashboard:/proxy/ <span class="keyword">in</span> your default browser...</span><br><span class="line">  - http://127.0.0.1:44278/api/v1/namespaces/kubernetes-dashboard/services/http:kubernetes-dashboard:/proxy/</span><br><span class="line"></span><br><span class="line"><span class="comment"># optional to forward it to vm host with default 8081 port, or '--port=xxxx' to specify another port</span></span><br><span class="line">$ kubectl proxy --address=<span class="string">'0.0.0.0'</span> --<span class="built_in">disable</span>-filter=<span class="literal">true</span> &amp;</span><br><span class="line">Request filter disabled, your proxy is vulnerable to XSRF attacks, please be cautious</span><br><span class="line">Starting to serve on [::]:8001</span><br><span class="line"></span><br><span class="line"><span class="comment"># (optional) or start dashboard and proxy at backend at the same time</span></span><br><span class="line">minikube dashboard &amp; kubectl proxy --address=<span class="string">'0.0.0.0'</span> --<span class="built_in">disable</span>-filter=<span class="literal">true</span> &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment"># (optional) how to stop a `backgroud` kubectl proxy?</span></span><br><span class="line"><span class="comment"># grep from netstat</span></span><br><span class="line">$ netstat -tulp | grep kubectl</span><br><span class="line">tcp6       0      0 [::]:vcom-tunnel        [::]:*                  LISTEN      13655/kubectl</span><br><span class="line"><span class="comment"># then kill the process by &lt;pid&gt;</span></span><br><span class="line">sudo <span class="built_in">kill</span> -9 &lt;pid&gt;</span><br></pre></td></tr></table></figure><p><img src="https://d33wubrfki0l68.cloudfront.net/349824f68836152722dab89465835e604719caea/6e0b7/images/docs/ui-dashboard.png" alt="K8S Dashboard"></p><p>visit dashboard via: <code>http://{localhost-or-forwarded-host}:8001/api/v1/namespaces/kubernetes-dashboard/services/http:kubernetes-dashboard:/proxy/#/workloads?namespace=_all</code></p><h2><span id="deploy-applications">Deploy Applications</span></h2><p>K8S manages <em>containered</em> applications, based on images from public registries like <a href="https://hub.docker.com/" target="_blank" rel="noopener">DockerHub</a> and also private regitries.</p><p>Here is our private registry, plain HTTP without SSL, for internal use only.<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># our private registry, for internal use only</span></span><br><span class="line">registry: chszctnr02:8082</span><br><span class="line">user: dockeradmin</span><br><span class="line">pass: 123456</span><br></pre></td></tr></table></figure></p><h3><span id="use-privacy-registry">Use Privacy Registry</span></h3><p>As we see that minikube starts a node in container, we can use <code>kubectl</code> to manage credential to registry as <code>secret</code>.</p><p>If the registry is a insecure registry (HTTP, not HTTPS), minikube can start with <code>--insecure-registry</code> option to pass into k8s nodes, e.g.<br><code>minikube start --insecure-registry=chszctnr02:8082</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># create namespace, e.g. cecs</span></span><br><span class="line">$ kubectl create namespace cecs</span><br><span class="line">namespace/cecs created</span><br><span class="line"></span><br><span class="line"><span class="comment"># create secret for private registry</span></span><br><span class="line">$ kubectl create secret docker-registry chszctnr02-registry --docker-server=chszctnr02:8082 --docker-username=dockeradmin --docker-password=123456 --namespace cecs</span><br><span class="line"></span><br><span class="line"><span class="comment"># (optional) configure minikube</span></span><br><span class="line">$ minikube config <span class="built_in">set</span> insecure-registry chszctnr02:8082</span><br><span class="line"></span><br><span class="line"><span class="comment"># (optional) view minikube config</span></span><br><span class="line">$ minikube config view</span><br><span class="line">- insecure-registry: chszctnr02:8082</span><br><span class="line"></span><br><span class="line"><span class="comment"># then try to start minikube with --insecure-registry option</span></span><br><span class="line">$ minikube start --insecure-registry=chszctnr02:8082</span><br><span class="line"></span><br><span class="line"><span class="comment"># if above minikube start with --insecure-registry does not work</span></span><br><span class="line"><span class="comment"># do `minikube delete` first and try again</span></span><br></pre></td></tr></table></figure><p>Then we can create k8s <code>workload</code> with <code>yaml</code> spec,<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment">#...</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">container:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">some-app</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">'chszctnr02:8082/somenamespace/someapp:tag'</span>  <span class="comment"># image for private registry</span></span><br><span class="line">      <span class="attr">imagePullSecrets:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">chszctnr02-registry</span>                           <span class="comment"># private registry secret name</span></span><br><span class="line">  <span class="comment">#...</span></span><br></pre></td></tr></table></figure></p><p>(Optional) If  use private registry from AWS, Azure, DockerHub, <code>minikube</code> offers the <code>registry-creds</code> addon to easily haddle the credentials. Please refer to <a href="https://minikube.sigs.k8s.io/docs/handbook/registry/" target="_blank" rel="noopener">minikube: Using a Private Registry</a>.</p><p>(Optional) If we use <code>docker</code> directly without <code>kubectl</code>, following steps to use an insecure registry.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (optional) login to private registry</span></span><br><span class="line"><span class="comment"># it will store credential in ~/.docker/config.json</span></span><br><span class="line">$ docker login chszctnr02:8082</span><br><span class="line">Username: dockeradmin</span><br><span class="line">Password: </span><br><span class="line">WARNING! Your password will be stored unencrypted <span class="keyword">in</span> /home/edworks/.docker/config.json.</span><br><span class="line">Configure a credential helper to remove this warning. See</span><br><span class="line">https://docs.docker.com/engine/reference/commandline/login/<span class="comment">#credentials-store</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (optional) trust insecure-registries, and restart docker ()</span></span><br><span class="line">$ vi /etc/docker/daemon.json </span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"insecure-registries"</span> : [<span class="string">"chszctnr02:8082"</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># restart docker to take effects</span></span><br><span class="line">$ systemctl restart docker</span><br></pre></td></tr></table></figure><h3><span id="deployment">Deployment</span></h3><p>Now it’s a k8s environment ready to deploy applications on your own ~</p><p>Following content are our own project deployments.</p><ul><li>Bundle all config items into one <code>ConfigMap</code> to easily manage configs</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># create a configmap holds all config files for specific Environment</span></span><br><span class="line"><span class="comment"># (optional) set item key (e.g. app-settings) to specific config file, otherwise the item key should be the same with file name(e.g. appsettings.Development.json)</span></span><br><span class="line">$ kubectl create configmap is-sts-conf-dev \ </span><br><span class="line">--from-file app-settings=./appsettings.Development.json \ </span><br><span class="line">--from-file portal-settings=./portal.Development.json \ </span><br><span class="line">--from-file serilog-settings=serilog.Development.json \ </span><br><span class="line">--namespace cecs</span><br><span class="line"><span class="comment"># configmap/is-sts-conf-dev created</span></span><br></pre></td></tr></table></figure><ul><li><a href="https://kubernetes.io/docs/concepts/configuration/configmap/#using-configmaps-as-files-from-a-pod" target="_blank" rel="noopener">Using ConfigMaps as files from a pod</a></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#create a deployment (partial, the volumes and mounts)</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app-conf-volume</span>                       <span class="comment"># mount ConfigMap in a volume</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">is-sts-conf-files-prod</span></span><br><span class="line">            <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dev-nop</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">'chszctnr02:8082/some-namespace/is-sts:0.dev.0.201019.ed1730bb'</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ASPNETCORE_ENVIRONMENT</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">Development</span></span><br><span class="line">          <span class="attr">resources:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app-conf-volume</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/app/portal.json</span>             <span class="comment"># target file in container</span></span><br><span class="line">              <span class="attr">subPath:</span> <span class="string">portal.Development.json</span>        <span class="comment"># source item in ConfigMap</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app-conf-volume</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/app/appsettings.json</span></span><br><span class="line">              <span class="attr">subPath:</span> <span class="string">appsettings.Development.json</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app-conf-volume</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/app/serilog.json</span></span><br><span class="line">              <span class="attr">subPath:</span> <span class="string">serilog.Development.json</span></span><br></pre></td></tr></table></figure><p>then apply to deveployment, we can see the configmap items will be map to pods/containers, like:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dive into pod:</span></span><br><span class="line"><span class="comment"># config items will be map into pods/container, OVERWRITE if exists</span></span><br><span class="line">root@pod: /app $ ls | grep json</span><br><span class="line">appsettings.json</span><br><span class="line">portal.json</span><br><span class="line">serilog.json</span><br><span class="line"></span><br><span class="line"><span class="comment"># if .spec.containers[].volumeMounts[].subPath is not speficifed, it will map all items to a dir</span></span><br></pre></td></tr></table></figure><ul><li>Create Secret to store senstive informations such as passwords, tokens, ssk keys.</li></ul><p><code>Secret</code> used with a Pod in three ways: </p><ul><li>a. a file in <code>volume</code> mounted to pods</li><li>b. as container environment variable</li><li>c. by the <code>kubelet</code> when pulling images (see above registry secret)</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># create secret --from-file or --from-literal</span></span><br><span class="line">kubectl create secret generic localhost-cert \ </span><br><span class="line">--from-file cert-file=./localhost.pfx \ </span><br><span class="line">--from-literal cert-pass=somepass \ </span><br><span class="line">--namespace cecs</span><br><span class="line"></span><br><span class="line"><span class="comment">#secret/localhost-cert created, type is Opaque</span></span><br><span class="line">$ kubectl get secrets -n cecs | grep cert</span><br><span class="line">localhost-cert        Opaque    2     11m</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cert-volume</span>                 <span class="comment"># secret as a volume</span></span><br><span class="line">          <span class="attr">secret:</span></span><br><span class="line">            <span class="attr">secretName:</span> <span class="string">localhost-cert</span>      <span class="comment"># the secret name</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">is-sts</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">'chszctnr02:8082/some-namespace/is-sts:1.0.8.200929.3226b1e1'</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ASPNETCORE_ENVIRONMENT</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">Development</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CertificateConfiguration__PfxFilePassword</span></span><br><span class="line">              <span class="attr">valueFrom:</span>                    <span class="comment"># usage#b, value from secret item as a env variable</span></span><br><span class="line">                <span class="attr">secretKeyRef:</span></span><br><span class="line">                    <span class="attr">key:</span> <span class="string">cert-pass</span>          <span class="comment"># the key to secret</span></span><br><span class="line">                    <span class="attr">name:</span> <span class="string">localhost-cert</span>    <span class="comment"># the secret name</span></span><br><span class="line">                    <span class="attr">optional:</span> <span class="literal">false</span></span><br><span class="line">          <span class="attr">resources:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cert-volume</span>             <span class="comment"># usage#a, mount secret as files</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/app/cert</span>          <span class="comment"># all items in secret will be map to files under this dir, here, /app/cert/cert-file, /app/cert-pass.</span></span><br></pre></td></tr></table></figure><p>then apply to deveployment, we can see the secret will be map to pods/containers, like:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dive into pod:</span></span><br><span class="line"><span class="comment"># usage#b, the raw secret item was set to env variable</span></span><br><span class="line">/app<span class="comment"># env | grep Pfx</span></span><br><span class="line">CertificateConfiguration__PfxFilePassword=somepass</span><br><span class="line"></span><br><span class="line"><span class="comment"># usage#a, the secret items were map to files.</span></span><br><span class="line">/app<span class="comment"># ls ./cert</span></span><br><span class="line">cert-file  cert-pass</span><br></pre></td></tr></table></figure><ul><li>Create a Service to expose as network service</li></ul><p><code>Service</code> is an abstract way to expose an application runing on a set of Pods as a network service, more about service please refer to <a href="https://kubernetes.io/docs/concepts/services-networking/service/" target="_blank" rel="noopener">Kubernetes Serviece</a>.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># expose pod 80 port to service 80 port</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">is-sts-service</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">cecs</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">  <span class="attr">app:</span> <span class="string">MyApp</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="number">80</span><span class="number">-80</span><span class="string">-tcp</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span>              <span class="comment"># incoming port</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span>        <span class="comment"># expose port</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br></pre></td></tr></table></figure><p>then apply, we can see we can see a <code>service</code> is created.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># a service is created</span></span><br><span class="line">$ kubectl get svc -n cecs</span><br><span class="line">NAMESPACE    NAME               TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)              AGE</span><br><span class="line">cecs         is-sts-service     NodePort    10.104.125.235   &lt;none&gt;        80:30971/TCP         2m30s</span><br></pre></td></tr></table></figure><p>Usually, for deployement, we can use <code>kubectl port-forward</code> to expose deployment directly without service.</p><ul><li>Port forwarding to access applications in a K8S cluster</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># forward deployment 80 to expose 8080</span></span><br><span class="line">$ kubectl -n cecs --address 0.0.0.0 port-forward deployment/is-sts 8080:80</span><br><span class="line"><span class="comment"># port is forwarding</span></span><br><span class="line">Forwarding from 127.0.0.1:8080 -&gt; 80</span><br><span class="line">Forwarding from [::1]:8080 -&gt; 80</span><br><span class="line"><span class="comment"># handle requests</span></span><br><span class="line">Handling connection <span class="keyword">for</span> 8080</span><br><span class="line"></span><br><span class="line"><span class="comment"># (optional) open firewall port</span></span><br><span class="line">$ firewall-cmd --add-port=8080/tcp --permanent</span><br><span class="line">$ firewall-cmd --reload</span><br></pre></td></tr></table></figure><h3><span id="minikube-addons">minikube addons</span></h3><p><code>minikube</code> has a built-in list of applications and services that may be easily deployed, such as Istio or Ingress. To list the available addons for your version of <code>minikube</code>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">$ minikube addons list</span><br><span class="line">|-----------------------------|----------|--------------|</span><br><span class="line">|         ADDON NAME          | PROFILE  |    STATUS    |</span><br><span class="line">|-----------------------------|----------|--------------|</span><br><span class="line">| ambassador                  | minikube | disabled     |</span><br><span class="line">| csi-hostpath-driver         | minikube | disabled     |</span><br><span class="line">| dashboard                   | minikube | enabled ✅   |</span><br><span class="line">| default-storageclass        | minikube | enabled ✅   |</span><br><span class="line">| efk                         | minikube | disabled     |</span><br><span class="line">| freshpod                    | minikube | disabled     |</span><br><span class="line">| gcp-auth                    | minikube | disabled     |</span><br><span class="line">| gvisor                      | minikube | disabled     |</span><br><span class="line">| helm-tiller                 | minikube | disabled     |</span><br><span class="line">| ingress                     | minikube | enabled ✅   |</span><br><span class="line">| ingress-dns                 | minikube | disabled     |</span><br><span class="line">| istio                       | minikube | disabled     |</span><br><span class="line">| istio-provisioner           | minikube | disabled     |</span><br><span class="line">| kubevirt                    | minikube | disabled     |</span><br><span class="line">| logviewer                   | minikube | disabled     |</span><br><span class="line">| metallb                     | minikube | disabled     |</span><br><span class="line">| metrics-server              | minikube | disabled     |</span><br><span class="line">| nvidia-driver-installer     | minikube | disabled     |</span><br><span class="line">| nvidia-gpu-device-plugin    | minikube | disabled     |</span><br><span class="line">| olm                         | minikube | disabled     |</span><br><span class="line">| pod-security-policy         | minikube | disabled     |</span><br><span class="line">| registry                    | minikube | disabled     |</span><br><span class="line">| registry-aliases            | minikube | disabled     |</span><br><span class="line">| registry-creds              | minikube | disabled     |</span><br><span class="line">| storage-provisioner         | minikube | enabled ✅   |</span><br><span class="line">| storage-provisioner-gluster | minikube | disabled     |</span><br><span class="line">| volumesnapshots             | minikube | disabled     |</span><br><span class="line">|-----------------------------|----------|--------------|</span><br><span class="line"></span><br><span class="line"><span class="comment"># to enable an add-on:</span></span><br><span class="line">$ minikube addons <span class="built_in">enable</span> &lt;name&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># to enable an addon at start-up, where –addons option can be specified multiple times:</span></span><br><span class="line">$ minikube start --addons &lt;name1&gt; --addons &lt;name2&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># for addons that expose a browser endpoint, you can quickly open them with:</span></span><br><span class="line">$ minikube addons open &lt;name&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># to disable an addon:</span></span><br><span class="line">$ minikube addons <span class="built_in">disable</span> &lt;name&gt;</span><br></pre></td></tr></table></figure><h2><span id="reference">Reference</span></h2><ul><li><a href="https://docs.docker.com/engine/install/centos/" target="_blank" rel="noopener">Install Docker Engine on CentOS</a></li><li><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/" target="_blank" rel="noopener">Install and Set Up kubectl</a></li><li><a href="https://minikube.sigs.k8s.io/docs/start/" target="_blank" rel="noopener">minikube start</a></li><li><a href="https://minikube.sigs.k8s.io/docs/drivers/" target="_blank" rel="noopener">minikube Drivers</a></li><li><a href="https://minikube.sigs.k8s.io/docs/handbook/registry/" target="_blank" rel="noopener">Using a Private Registry / Enabling Insecure Registries</a></li><li><a href="https://kubernetes.io/docs/concepts/configuration/configmap/#using-configmaps-as-files-from-a-pod" target="_blank" rel="noopener">Using ConfigMaps as files from a Pod</a></li><li><a href="https://kubernetes.io/docs/concepts/configuration/secret/" target="_blank" rel="noopener">Kubernetes Secrets</a></li><li><a href="https://kubernetes.io/docs/concepts/services-networking/service/" target="_blank" rel="noopener">Kubernetes Serviece</a></li><li><a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands" target="_blank" rel="noopener">Kubectl Commands Reference</a></li><li><a href="https://phoenixnap.com/kb/understanding-kubernetes-architecture-diagrams" target="_blank" rel="noopener">Understanding Kubernetes Architecture With Diagrams</a></li><li><a href="https://www.thegeekdiary.com/how-to-open-a-ports-in-centos-rhel-7/#:~:text=How%20To%20Open%20A%20Port%20In%20CentOS%20%2F,firewall%20ports%205.%20Check%20newly%20added%20port%20status" target="_blank" rel="noopener">How To Open A Port In CentOS / RHEL 7</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;!-- Quick Start A Local-Hosted K8S Environment --&gt;
&lt;p&gt;&lt;em&gt;Kubernetes&lt;/em&gt; (K8S) is an open-source system for automating deployment, scaling, and management of containerized applications, which is now graduated from &lt;a href=&quot;https://www.cncf.io/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;CNCF&lt;/a&gt;. &lt;/p&gt;
&lt;p&gt;All cloud service providers like AWS, Azure, Aliyun, Tecent Cloud are now providing cloud-based and easy-to-use K8S infrastructure.&lt;/p&gt;
&lt;p&gt;Here uses &lt;a href=&quot;https://minikube.sigs.k8s.io/docs/start/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;minikue&lt;/a&gt; to quick start a new local K8S environment for development.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/kubernetes/kubernetes/587d164307de060d271f10f2386f39153360fba9/docs/design/architecture.svg&quot; alt=&quot;K8S Architecture&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;Requirements&quot;&gt;&lt;a href=&quot;#Requirements&quot; class=&quot;headerlink&quot; title=&quot;Requirements&quot;&gt;&lt;/a&gt;Requirements&lt;/h2&gt;&lt;p&gt;&lt;code&gt;Minikube&lt;/code&gt; supports container or virtual machine manager, such as &lt;a href=&quot;https://minikube.sigs.k8s.io/docs/start/#what-youll-need&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Docker, Hyperkit, Hyper-V, KVM, Parallels, Podman, VirtualBox, or VMWare&lt;/a&gt;. &lt;/p&gt;
&lt;p&gt;I start from CentOS 7 VM (&lt;em&gt;2+ cpu, 4GB memory, 20+GB disk&lt;/em&gt;).&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;Install &lt;code&gt;Docker&lt;/code&gt; &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;refer to &lt;a href=&quot;https://docs.docker.com/engine/install/centos/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Install Docker Engine on CentOS&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Install Kubectl&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;refer to &lt;a href=&quot;https://kubernetes.io/docs/tasks/tools/install-kubectl/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Install and Set Up kubectl&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Install minikube&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;refer to &lt;a href=&quot;https://minikube.sigs.k8s.io/docs/start/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;minikube start&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="学习笔记" scheme="http://xiao-fang.cc/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
      <category term="Kubernetes" scheme="http://xiao-fang.cc/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/Kubernetes/"/>
    
    
      <category term="CentOS" scheme="http://xiao-fang.cc/tags/CentOS/"/>
    
      <category term="Kubernetes" scheme="http://xiao-fang.cc/tags/Kubernetes/"/>
    
      <category term="minikube" scheme="http://xiao-fang.cc/tags/minikube/"/>
    
      <category term="Kubectl" scheme="http://xiao-fang.cc/tags/Kubectl/"/>
    
  </entry>
  
  <entry>
    <title>元夕新雨</title>
    <link href="http://xiao-fang.cc/2018/03/04/poem-yuanxi-xinyu/"/>
    <id>http://xiao-fang.cc/2018/03/04/poem-yuanxi-xinyu/</id>
    <published>2018-03-04T00:00:00.000Z</published>
    <updated>2020-11-16T01:47:12.577Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>岁在戊戌(2018)元夕后, 晨起过广场, 看香销草长新雨透, 得此句.<br>by 一粟生</p></blockquote><blockquote class="blockquote-center"><br><b>元夕新雨</b><br>雨湿梅花落, 风吹蔓草生.<br>花草相与好, 一岁一重逢.<br></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;岁在戊戌(2018)元夕后, 晨起过广场, 看香销草长新雨透, 得此句.&lt;br&gt;by 一粟生&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote class=&quot;blockquote-center&quot;&gt;&lt;br&gt;&lt;b&gt;元夕新雨&lt;/b&gt;&lt;br&gt;雨湿
      
    
    </summary>
    
      <category term="闲言随笔" scheme="http://xiao-fang.cc/categories/%E9%97%B2%E8%A8%80%E9%9A%8F%E7%AC%94/"/>
    
    
  </entry>
  
  <entry>
    <title>十八</title>
    <link href="http://xiao-fang.cc/2017/12/30/poem-shiba/"/>
    <id>http://xiao-fang.cc/2017/12/30/poem-shiba/</id>
    <published>2017-12-30T00:00:00.000Z</published>
    <updated>2020-11-16T01:47:12.577Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>2017年倒数几天, 朋友都刷屏’最后一批90后也将成年(满18)’, 追忆十八岁, 想来自己今年廿八, 年后奔三十, 得两三言.<br>by 一粟生</p></blockquote><blockquote class="blockquote-center"><br><b>十八</b><br>十八有基友, 廿八执卿手.<br>年后奔三十, 犹羡零零后.<br></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;2017年倒数几天, 朋友都刷屏’最后一批90后也将成年(满18)’, 追忆十八岁, 想来自己今年廿八, 年后奔三十, 得两三言.&lt;br&gt;by 一粟生&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote class=&quot;blockquote-
      
    
    </summary>
    
      <category term="闲言随笔" scheme="http://xiao-fang.cc/categories/%E9%97%B2%E8%A8%80%E9%9A%8F%E7%AC%94/"/>
    
    
  </entry>
  
  <entry>
    <title>PHP unserialize() [function.unserialize]: Error at offset</title>
    <link href="http://xiao-fang.cc/2017/11/16/php-unserialize-error-at-offset/"/>
    <id>http://xiao-fang.cc/2017/11/16/php-unserialize-error-at-offset/</id>
    <published>2017-11-16T18:00:00.000Z</published>
    <updated>2020-11-16T01:47:12.577Z</updated>
    
    <content type="html"><![CDATA[<p>These days I meet a strange issue that I tried to publish my WordPress site from local hosted to a cloud Linux environment.</p><table><thead><tr><th>MySQL Env</th><th>Charset</th><th>Collation</th></tr></thead><tbody><tr><td>Local</td><td>utf8 – UTF-8 Unicode</td><td>utf8_general_ci</td></tr><tr><td>Cloud Linux</td><td>utf8mb4 – UTF-8 Unicode</td><td>utf8mb4_unicode_ci</td></tr></tbody></table><p>After days’ deep investigation (a php starter) I found that the root cause is the <code>unserialize()</code> issue. There is a function <code>maybe_unserialize</code> in source code as following, that process an unsafe <code>@unserialize</code> the original data from MySQL databaes.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">maybe_unserialize</span><span class="params">($original)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (is_serialized($original)) &#123;</span><br><span class="line">        <span class="keyword">return</span> @unserialize($original);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $original;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>For example, as following it would throw an error that <code>Error at offset xx of xx bytes in [...]</code> and return <code>bool(false)</code>;</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$opt =<span class="string">'a:2:&#123;s:36:"field_a";s:2:"on";s:31:"field_b";s:2:"off";&#125;'</span>;</span><br><span class="line">var_dump(maybe_unserialize($opt)) ;</span><br><span class="line"></span><br><span class="line"><span class="comment">//output</span></span><br><span class="line">&lt;br /&gt; &lt;b&gt;Notice&lt;/b&gt;: unserialize(): Error at offset <span class="number">47</span> of <span class="number">55</span> bytes in &lt;b&gt;[...][...]&lt;/b&gt; on line &lt;b&gt;<span class="number">69</span>&lt;/b&gt;&lt;br /&gt; bool(<span class="keyword">false</span>)</span><br></pre></td></tr></table></figure><a id="more"></a><p>Above issue, caused by different database charest encoding between from both MySQL databases, that can be resolve by following two steps.</p><h4><span id="step-1-correct-existing-mis-match-encoding-data">step 1 - correct existing mis-match encoding data</span></h4><p>Add a new method <code>serialize_corrector</code> and apply it <strong>before</strong> a serialized data from <code>unserialize</code> (do a correction).</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">serialize_corrector</span><span class="params">($data)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> preg_replace_callback(<span class="string">'!s:(\d+):"(.*?)";!'</span>, <span class="function"><span class="keyword">function</span><span class="params">($m)</span> </span>&#123; <span class="keyword">return</span> <span class="string">'s:'</span>.strlen($m[<span class="number">2</span>]).<span class="string">':"'</span>.$m[<span class="number">2</span>].<span class="string">'";'</span>; &#125;, $data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">maybe_unserialize</span><span class="params">( $original )</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> ( is_serialized( $original ) )&#123;</span><br><span class="line">   <span class="keyword">return</span>   unserialize( serialize_corrector ($original) );</span><br><span class="line">   <span class="comment">// return   unserialize(   $original  );</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> $original;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>then correct ~</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$opt =<span class="string">'a:2:&#123;s:36:"field_a";s:2:"on";s:31:"field_b";s:2:"off";&#125;'</span>;</span><br><span class="line">var_dump(maybe_unserialize($opt)) ;</span><br><span class="line"></span><br><span class="line"><span class="comment">// output</span></span><br><span class="line"><span class="keyword">array</span>(<span class="number">2</span>) &#123; [<span class="string">"field_a"</span>]=&gt; string(<span class="number">2</span>) <span class="string">"on"</span> [<span class="string">"field_b"</span>]=&gt; string(<span class="number">3</span>) <span class="string">"off"</span> &#125;</span><br></pre></td></tr></table></figure><h4><span id="step-2-update-database-encoding">step 2 - update database encoding</span></h4><ul><li>update the datbase <code>charset</code> to <code>utf8 -- UTF-8 Unicode</code></li><li>update the database <code>collation</code> to <code>utf8_general_ci</code></li></ul><h4><span id="references">References</span></h4><ul><li><a href="https://stackoverflow.com/questions/10152904/unserialize-function-unserialize-error-at-offset" target="_blank" rel="noopener">https://stackoverflow.com/questions/10152904/unserialize-function-unserialize-error-at-offset</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;These days I meet a strange issue that I tried to publish my WordPress site from local hosted to a cloud Linux environment.&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;MySQL Env&lt;/th&gt;
&lt;th&gt;Charset&lt;/th&gt;
&lt;th&gt;Collation&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;Local&lt;/td&gt;
&lt;td&gt;utf8 – UTF-8 Unicode&lt;/td&gt;
&lt;td&gt;utf8_general_ci&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Cloud Linux&lt;/td&gt;
&lt;td&gt;utf8mb4 – UTF-8 Unicode&lt;/td&gt;
&lt;td&gt;utf8mb4_unicode_ci&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;After days’ deep investigation (a php starter) I found that the root cause is the &lt;code&gt;unserialize()&lt;/code&gt; issue. There is a function &lt;code&gt;maybe_unserialize&lt;/code&gt; in source code as following, that process an unsafe &lt;code&gt;@unserialize&lt;/code&gt; the original data from MySQL databaes.&lt;/p&gt;
&lt;figure class=&quot;highlight php&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;maybe_unserialize&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;($original)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (is_serialized($original)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; @unserialize($original);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; $original;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;For example, as following it would throw an error that &lt;code&gt;Error at offset xx of xx bytes in [...]&lt;/code&gt; and return &lt;code&gt;bool(false)&lt;/code&gt;;&lt;/p&gt;
&lt;figure class=&quot;highlight php&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$opt =&lt;span class=&quot;string&quot;&gt;&#39;a:2:&amp;#123;s:36:&quot;field_a&quot;;s:2:&quot;on&quot;;s:31:&quot;field_b&quot;;s:2:&quot;off&quot;;&amp;#125;&#39;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;var_dump(maybe_unserialize($opt)) ;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//output&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;lt;br /&amp;gt; &amp;lt;b&amp;gt;Notice&amp;lt;/b&amp;gt;: unserialize(): Error at offset &lt;span class=&quot;number&quot;&gt;47&lt;/span&gt; of &lt;span class=&quot;number&quot;&gt;55&lt;/span&gt; bytes in &amp;lt;b&amp;gt;[...][...]&amp;lt;/b&amp;gt; on line &amp;lt;b&amp;gt;&lt;span class=&quot;number&quot;&gt;69&lt;/span&gt;&amp;lt;/b&amp;gt;&amp;lt;br /&amp;gt; bool(&lt;span class=&quot;keyword&quot;&gt;false&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="学以致用" scheme="http://xiao-fang.cc/categories/%E5%AD%A6%E4%BB%A5%E8%87%B4%E7%94%A8/"/>
    
      <category term="WordPress" scheme="http://xiao-fang.cc/categories/%E5%AD%A6%E4%BB%A5%E8%87%B4%E7%94%A8/WordPress/"/>
    
    
      <category term="WordPress" scheme="http://xiao-fang.cc/tags/WordPress/"/>
    
      <category term="PHP" scheme="http://xiao-fang.cc/tags/PHP/"/>
    
      <category term="MySQL" scheme="http://xiao-fang.cc/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>Lightweight Docker Image with Node.js + Git Runtime</title>
    <link href="http://xiao-fang.cc/2017/11/08/lightweight-node-git-docker/"/>
    <id>http://xiao-fang.cc/2017/11/08/lightweight-node-git-docker/</id>
    <published>2017-11-08T10:30:00.000Z</published>
    <updated>2020-11-16T01:47:12.577Z</updated>
    
    <content type="html"><![CDATA[<p>It’s now very popular and convinient to use <code>docker</code> as powerful development and deployment tool. For me, node.js and git are heavily used in daily works.</p><h4><span id="official-image-variants-of-nodejs">Official Image Variants of Node.js</span></h4><p>There are official <a href="https://hub.docker.com/_/node/" target="_blank" rel="noopener"><code>Node</code></a> images on <code>Docker Hub</code> with many many tags, as following:</p><ul><li><code>9.x.x</code> / <code>latest</code> are the standard images with common packages</li><li><code>alpine</code> bases on very small linux distribution <a href="https://alpinelinux.org" target="_blank" rel="noopener"><code>Alpine</code></a></li><li><code>slim</code> does not contain the common packages contained in the default tag and only contains the minimal packages needed to run node, highly recommend using the default image of this repository.</li></ul><p>Now let’s take a look at these images, that <code>node:alpine</code> is only ~67MB, and the <code>node:slim</code> is 230MB larger, but the <code>node:lastest</code> is about 650MB huge!</p><blockquote><p>If it only need a Node.js runtime, that <code>node:latest</code> is too heavy and the <code>node:slim</code> is recommened but the <code>node:alpine</code> is the most lightweight.</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker images | grep node</span></span><br><span class="line">node        slim                992fa76c5ada        3 days ago          230 MB</span><br><span class="line">node        alpine              d06e52d14cac        3 days ago          67.4 MB</span><br><span class="line">node        boron               cf1a65507771        3 months ago        656 MB</span><br><span class="line">node        latest              d2ea9785e1cb        3 months ago        665 MB</span><br></pre></td></tr></table></figure><h4><span id="nodealpine-git"><code>node:alpine</code> + Git</span></h4><p>Now what I need is Node.Js runtime with Git available, so I take <code>node:alpine</code> as base image then pre-install the <code>git</code>. The <code>Dockerflie</code> is as following:</p><figure class="highlight docker"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> node:alpine</span><br><span class="line"></span><br><span class="line"><span class="keyword">LABEL</span><span class="bash"> maintainer Fang Xiao &lt;xiao.fang@outlook.com&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apk --update add git openssh &amp;&amp; \</span></span><br><span class="line"><span class="bash">    rm -rf /var/lib/apt/lists/* &amp;&amp; \</span></span><br><span class="line"><span class="bash">    rm /var/cache/apk/*</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"git"</span>, <span class="string">"--help"</span>]</span></span><br></pre></td></tr></table></figure><p>It’s pretty easy, right. Now I pushed it on <a href="https://hub.docker.com" target="_blank" rel="noopener"><code>Docker Hub</code></a> as <a href="https://hub.docker.com/r/realedward/node-git-alpine/" target="_blank" rel="noopener"><code>realedward/node-git-alpine</code></a>, and the source code hosted on <a href="https://github.com/xiao-fang/node-git-alpine" target="_blank" rel="noopener">https://github.com/xiao-fang/node-git-alpine</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker pull realedward/node-git-alpine</span></span><br></pre></td></tr></table></figure><p>Now we can see the size of <code>realedward/node-git-alpine</code> image is only about <em>90MB</em> ~</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">realedward/node-git-alpine  latest              ae12ac0300d1        18 hours ago        92.8 MB</span><br></pre></td></tr></table></figure><h4><span id="show-time-quick-nodejs-git-runtime">[Show Time] - quick <code>Node.Js + Git</code> runtime</span></h4><p>Here comes a demo to quick setup Node.js + Git runtime via only one command line <code>docker run -it --rm realedward/node-git-alpine /bin/sh</code>.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker run -it --rm realedward/node-git-alpine /bin/sh</span></span><br><span class="line">/ <span class="comment"># node -v</span></span><br><span class="line">v9.0.0</span><br><span class="line">/ <span class="comment"># npm -v</span></span><br><span class="line">5.5.1</span><br><span class="line">/ <span class="comment"># git --version</span></span><br><span class="line">git version 2.13.5</span><br><span class="line">/ <span class="comment">#</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;It’s now very popular and convinient to use &lt;code&gt;docker&lt;/code&gt; as powerful development and deployment tool. For me, node.js and git are 
      
    
    </summary>
    
      <category term="学以致用" scheme="http://xiao-fang.cc/categories/%E5%AD%A6%E4%BB%A5%E8%87%B4%E7%94%A8/"/>
    
      <category term="Docker" scheme="http://xiao-fang.cc/categories/%E5%AD%A6%E4%BB%A5%E8%87%B4%E7%94%A8/Docker/"/>
    
    
      <category term="Docker" scheme="http://xiao-fang.cc/tags/Docker/"/>
    
      <category term="Node.Js" scheme="http://xiao-fang.cc/tags/Node-Js/"/>
    
      <category term="Git" scheme="http://xiao-fang.cc/tags/Git/"/>
    
  </entry>
  
  <entry>
    <title>草珠子</title>
    <link href="http://xiao-fang.cc/2017/10/03/poem-caozhuzi/"/>
    <id>http://xiao-fang.cc/2017/10/03/poem-caozhuzi/</id>
    <published>2017-10-03T00:00:00.000Z</published>
    <updated>2020-11-16T01:47:12.577Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>岁在丁酉(2017), 国庆携女友归家游, 偶得陌上草珠子以结链相赠, 附此句.<br>by 一粟生</p></blockquote><blockquote class="blockquote-center"><br><b>草珠子</b><br>陌上草珠子, 采得百余粒.<br>结成一手链, 遗我心中意.<br></blockquote><p><img src="/uploads/poem-caozhuzi.jpg" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;岁在丁酉(2017), 国庆携女友归家游, 偶得陌上草珠子以结链相赠, 附此句.&lt;br&gt;by 一粟生&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote class=&quot;blockquote-center&quot;&gt;&lt;br&gt;&lt;b&gt;草珠子&lt;/b&gt;&lt;br
      
    
    </summary>
    
      <category term="闲言随笔" scheme="http://xiao-fang.cc/categories/%E9%97%B2%E8%A8%80%E9%9A%8F%E7%AC%94/"/>
    
    
  </entry>
  
  <entry>
    <title>秋分</title>
    <link href="http://xiao-fang.cc/2017/09/23/poem-qiufen/"/>
    <id>http://xiao-fang.cc/2017/09/23/poem-qiufen/</id>
    <published>2017-09-23T00:00:00.000Z</published>
    <updated>2020-11-16T01:47:12.577Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>岁在丁酉(2017), 秋分, 夜雨微凉.<br>by 一粟生</p></blockquote><blockquote class="blockquote-center"><br><b>秋分</b><br>昨夜清凉雨, 今晨已秋分.<br>笑我忘关窗, 冻醒睡梦人.<br></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;岁在丁酉(2017), 秋分, 夜雨微凉.&lt;br&gt;by 一粟生&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote class=&quot;blockquote-center&quot;&gt;&lt;br&gt;&lt;b&gt;秋分&lt;/b&gt;&lt;br&gt;昨夜清凉雨, 今晨已秋分.&lt;br&gt;笑我
      
    
    </summary>
    
      <category term="闲言随笔" scheme="http://xiao-fang.cc/categories/%E9%97%B2%E8%A8%80%E9%9A%8F%E7%AC%94/"/>
    
    
  </entry>
  
  <entry>
    <title>Join CentOS into Windows Active Directory Domain</title>
    <link href="http://xiao-fang.cc/2017/07/11/join-centos-to-windows-ad/"/>
    <id>http://xiao-fang.cc/2017/07/11/join-centos-to-windows-ad/</id>
    <published>2017-07-11T15:30:00.000Z</published>
    <updated>2020-11-16T01:47:12.577Z</updated>
    
    <content type="html"><![CDATA[<p>This tutorial guides how to join a CentOS machine into a Windows AD (Active Directory) domain.</p><blockquote><p>Ref: <a href="https://www.server-world.info/en/note?os=CentOS_7&amp;p=realmd" target="_blank" rel="noopener">Join in Windows Active Directory</a> @ <a href="https://www.server-world.info" target="_blank" rel="noopener"><strong>Server-World</strong></a></p></blockquote><h2><span id="prerequisites">Prerequisites</span></h2><ul><li><code>Windows AD</code> (Active Directory) domain service reachable.</li><li><code>CentOS</code> machine or virtual machine. (make sure the machine is connected into your LAN)</li><li>Sometimes, according to specific company Domain policy, a fully-qualified machine name should be requested firstly then it can be assigned.</li></ul><h2><span id="install-some-required-packages">Install some required packages</span></h2><p>Install some required packages as following.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum -y install realmd sssd oddjob oddjob-mkhomedir adcli samba-common</span><br></pre></td></tr></table></figure></p><h2><span id="change-hostname-optional">Change hostname <code>(Optional)</code></span></h2><p>For example, here I change the hostname to <code>testvm</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># hostname testvm</span></span><br></pre></td></tr></table></figure></p><a id="more"></a><h2><span id="align-the-machines-dns-to-ads-one">Align the machine’s DNS to AD’s one</span></h2><ul><li>Firstly, check the network interface name, here my network interface name is <code>eno16777736</code>.</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@testvm ~]<span class="comment"># ip link</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">2: eno16777736: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP mode DEFAULT qlen 1000</span><br><span class="line">    link/ether 00:0c:29:ed:af:0c brd ff:ff:ff:ff:ff:ff</span><br></pre></td></tr></table></figure><ul><li>Then change the CentOS DNS to AD’s one. (<strong>refer to</strong>: <a href="https://www.cs.cmu.edu/~help/networking/check-dns-settings.html" target="_blank" rel="noopener">How to check DNS setting?</a> )</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># change the DNS to AD's one</span></span><br><span class="line">[root@testvm ~]<span class="comment"># nmcli c modify eno16777736 ipv4.dns xx.xxx.xxx.xxx</span></span><br><span class="line">[root@testvm ~]<span class="comment"># nmcli c down eno16777736; nmcli c up eno16777736</span></span><br><span class="line">Connection <span class="string">'eno16777736'</span> successfully deactivated (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/0)</span><br><span class="line">Connection successfully activated (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/2)</span><br></pre></td></tr></table></figure><h2><span id="discovery-ad-domain">Discovery AD domain</span></h2><p>For example, here the demo AD domain is <code>domain.hostname.com</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@testvm ~]<span class="comment"># realm discover domain.hostname.com</span></span><br><span class="line">domain.hostname.com</span><br><span class="line">  <span class="built_in">type</span>: kerberos</span><br><span class="line">  realm-name: DOMAIN.HOSTNAME.COM</span><br><span class="line">  domain-name: domain.hostname.com</span><br><span class="line">  configured: no</span><br><span class="line">  server-software: active-directory</span><br><span class="line">  client-software: sssd</span><br><span class="line">  required-package: oddjob</span><br><span class="line">  required-package: oddjob-mkhomedir</span><br><span class="line">  required-package: sssd</span><br><span class="line">  required-package: adcli</span><br><span class="line">  required-package: samba-common-tools</span><br></pre></td></tr></table></figure><h2><span id="join-into-ad-domain">Join into AD domain</span></h2><p>Attempt to Join into domain, should provide AD admin user authentication.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@testvm ~]<span class="comment"># realm join -U adminuser --computer-name testvm DOMAIN.HOSTNAME.COM</span></span><br><span class="line">Password <span class="keyword">for</span> adminuser:  <span class="comment"># AD's Administrator password here</span></span><br></pre></td></tr></table></figure><p>Here in CentOS 7, errors may happen as following, because necessary packages are not installed. just go ahead to install them on.  <code>(Optional)</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># errors</span></span><br><span class="line">See: journalctl REALMD_OPERATION=r1408.50942</span><br><span class="line">realm: Couldn<span class="string">'t join realm: Necessary packages are not installed: oddjob, oddjob-mkhomedir, sssd, samba-common-tools</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># install on neccessary packages</span></span><br><span class="line"><span class="string">[root@testvm ~]# yum install -y ddjob oddjob-mkhomedir sssd samba-common-tool</span></span><br></pre></td></tr></table></figure><h2><span id="have-a-check">Have a check</span></h2><blockquote><p><strong>Note</strong>: Though joined into domain successfully as above, it may still take some time to sync to take effect for following check.<br>(It takes above 20 minutes in my demo environment.)</p></blockquote><ul><li>List realms, here should list the domain just added.</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@testvm ~]<span class="comment"># realm list</span></span><br><span class="line">domain.hostname.com</span><br><span class="line">  <span class="built_in">type</span>: kerberos</span><br><span class="line">  realm-name: DOMAIN.HOSTNAME.COM</span><br><span class="line">  domain-name: domain.hostname.com</span><br><span class="line">  configured: kerberos-member</span><br><span class="line">  server-software: active-directory</span><br><span class="line">  client-software: sssd</span><br><span class="line">  required-package: oddjob</span><br><span class="line">  required-package: oddjob-mkhomedir</span><br><span class="line">  required-package: sssd</span><br><span class="line">  required-package: adcli</span><br><span class="line">  required-package: samba-common-tools</span><br><span class="line">  login-formats: %U@domain.hostname.com</span><br><span class="line">  login-policy: allow-realm-logins</span><br></pre></td></tr></table></figure><ul><li>Get AD user info</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@testvm ~]<span class="comment"># id DOMAIN\\XXUSER      # use the REAL ad user here</span></span><br><span class="line"><span class="comment"># expected: list domain user info here</span></span><br></pre></td></tr></table></figure><ul><li>Switch to login via AD user</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@testvm ~]<span class="comment"># su - DOMAIN\\XXUSER      # use the REAL ad user here</span></span><br><span class="line"><span class="comment"># expected: switched to XXUSER</span></span><br></pre></td></tr></table></figure><ul><li>Print fully-qualified hostname</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@testvm ~]<span class="comment"># hostname -f</span></span><br><span class="line"><span class="comment"># expected: testvm.domain.hostname.com</span></span><br></pre></td></tr></table></figure><h2><span id="configure-to-not-use-fully-qualified-user-name-optional">Configure to not use fully qualified user name <code>(Optional)</code></span></h2><p>It’s always to long to use fully qualified AD user name, that it can be configured to NOT. <code>use_fully_qualified_names = False</code>.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@testvm ~]<span class="comment"># vi /etc/sssd/sssd.conf</span></span><br><span class="line"><span class="comment"># change use_fully_qualified_names to False</span></span><br><span class="line">use_fully_qualified_names = False</span><br><span class="line"></span><br><span class="line"><span class="comment"># restart sssd to take effect</span></span><br><span class="line">[root@testvm ~]<span class="comment"># systemctl restart sssd</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;This tutorial guides how to join a CentOS machine into a Windows AD (Active Directory) domain.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Ref: &lt;a href=&quot;https://www.server-world.info/en/note?os=CentOS_7&amp;amp;p=realmd&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Join in Windows Active Directory&lt;/a&gt; @ &lt;a href=&quot;https://www.server-world.info&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;&lt;strong&gt;Server-World&lt;/strong&gt;&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;Prerequisites&quot;&gt;&lt;a href=&quot;#Prerequisites&quot; class=&quot;headerlink&quot; title=&quot;Prerequisites&quot;&gt;&lt;/a&gt;Prerequisites&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;code&gt;Windows AD&lt;/code&gt; (Active Directory) domain service reachable.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;CentOS&lt;/code&gt; machine or virtual machine. (make sure the machine is connected into your LAN)&lt;/li&gt;
&lt;li&gt;Sometimes, according to specific company Domain policy, a fully-qualified machine name should be requested firstly then it can be assigned.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;Install-some-required-packages&quot;&gt;&lt;a href=&quot;#Install-some-required-packages&quot; class=&quot;headerlink&quot; title=&quot;Install some required packages&quot;&gt;&lt;/a&gt;Install some required packages&lt;/h2&gt;&lt;p&gt;Install some required packages as following.&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;sudo yum -y install realmd sssd oddjob oddjob-mkhomedir adcli samba-common&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;Change-hostname-Optional&quot;&gt;&lt;a href=&quot;#Change-hostname-Optional&quot; class=&quot;headerlink&quot; title=&quot;Change hostname (Optional)&quot;&gt;&lt;/a&gt;Change hostname &lt;code&gt;(Optional)&lt;/code&gt;&lt;/h2&gt;&lt;p&gt;For example, here I change the hostname to &lt;code&gt;testvm&lt;/code&gt;&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[root@localhost ~]&lt;span class=&quot;comment&quot;&gt;# hostname testvm&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="学以致用" scheme="http://xiao-fang.cc/categories/%E5%AD%A6%E4%BB%A5%E8%87%B4%E7%94%A8/"/>
    
      <category term="CentOS" scheme="http://xiao-fang.cc/categories/%E5%AD%A6%E4%BB%A5%E8%87%B4%E7%94%A8/CentOS/"/>
    
    
      <category term="CentOS" scheme="http://xiao-fang.cc/tags/CentOS/"/>
    
      <category term="Active Directory" scheme="http://xiao-fang.cc/tags/Active-Directory/"/>
    
      <category term="AD" scheme="http://xiao-fang.cc/tags/AD/"/>
    
      <category term="Domain" scheme="http://xiao-fang.cc/tags/Domain/"/>
    
  </entry>
  
  <entry>
    <title>Npm, Bower, Git, and Bash Proxy Configurations</title>
    <link href="http://xiao-fang.cc/2017/06/27/npm-bower-git-etc-proxy-configs/"/>
    <id>http://xiao-fang.cc/2017/06/27/npm-bower-git-etc-proxy-configs/</id>
    <published>2017-06-27T14:00:00.000Z</published>
    <updated>2020-11-16T01:47:12.577Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p><strong>Npm, Bower, Git, and Bash Proxy Configurations</strong><br>Original Post: <a href="http://digitaldrummerj.me/proxy-configurations/" target="_blank" rel="noopener">http://digitaldrummerj.me/proxy-configurations/</a> on <code>2015-08-03</code><br>Copyright © <a href="http://digitaldrummerj.me/" target="_blank" rel="noopener"><strong>Justin James</strong></a></p></blockquote><p>When you are using npm, bower, and git behind a proxy server you have to do a little bit of configuration. Luckily it is super easy to do these configurations. Almost all of the programs have command line commands to set and unset the proxy server.</p><h2><span id="updates">Updates</span></h2><ul><li><strong>Updated 2015-Feb-01</strong>: Added running source command for Bash and Ruby Gems section</li><li><strong>Updated 2015-May-07</strong>: Added the Ionic Start command</li><li><strong>Updated 2015-May-08</strong>: Added the Android SDK</li><li><strong>Updated 2015-Aug-03</strong>: Added command lines to set proxy</li><li><strong>Updated 2015-Oct-20</strong>: Added Gradle</li></ul><h2><span id="windows-command-prompt">Windows Command Prompt</span></h2><h3><span id="current-command-prompt-only">Current Command Prompt Only</span></h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> http_proxy=[Your Proxy]:[Proxy Port]</span><br><span class="line"><span class="built_in">set</span> https_proxy=[Your Proxy]:[Proxy Port]</span><br></pre></td></tr></table></figure><h3><span id="unset-current-session">Unset Current Session</span></h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> http_proxy=</span><br><span class="line"><span class="built_in">set</span> https_proxy=</span><br></pre></td></tr></table></figure><a id="more"></a><h3><span id="globally-as-a-system-environment-variable">Globally as a System Environment Variable</span></h3><p>Run from an administrative command prompt</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setx http_proxy=[Your Proxy]:[Proxy Port] /M</span><br><span class="line">setx https_proxy=[Your Proxy]:[Proxy Port] /M</span><br></pre></td></tr></table></figure><p>You will need to close and re-open command prompt for settings to take effect</p><h3><span id="globally-as-a-user-environment-variable">Globally as a User Environment Variable</span></h3><p>Run from a non-administrative command prompt</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setx http_proxy=[Your Proxy]:[Proxy Port]</span><br><span class="line">setx https_proxy=[Your Proxy]:[Proxy Port]</span><br></pre></td></tr></table></figure><p>You will need to close and re-open command prompt for settings to take effect</p><h3><span id="unset-globally-system-environment-variable">Unset Globally System Environment Variable</span></h3><p>Run from an administrative command prompt</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setx http_proxy="" /M</span><br><span class="line">setx https_proxy="" /M</span><br></pre></td></tr></table></figure><p>Need to close and re-open command prompt for settings to take effect</p><h3><span id="unset-globally-user-environment-variable">Unset Globally User Environment Variable</span></h3><p>Run from a non-administrative command prompt</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setx http_proxy=""</span><br><span class="line">setx https_proxy=""</span><br></pre></td></tr></table></figure><p>Need to close and re-open command prompt for settings to take effect</p><h3><span id="view-proxy-settings">View Proxy Settings</span></h3><p>If the commands below just echo out the text instead of the actual proxy server, it means that the proxy server is not set.</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="variable">%http_proxy%</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">%https_proxy%</span></span><br></pre></td></tr></table></figure><hr><h2><span id="bash-shell">Bash Shell</span></h2><p>File Name: <code>.bash_profile</code> or <code>.bashrc</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> http_proxy=[Your Proxy]:[Proxy Port]</span><br><span class="line"><span class="built_in">export</span> https_proxy=[Your Proxy]:[Proxy Port]</span><br><span class="line"><span class="built_in">export</span> npm_config_proxy=[Your Proxy]:[Proxy Port]</span><br><span class="line"><span class="built_in">export</span> npm_config_https_proxy=[Your Proxy]:[Proxy Port]</span><br></pre></td></tr></table></figure><p>Note: After updated the <code>.bash_profile</code> or <code>.bashrc</code>, you should run one of the following commands to make the configuration active for the current session.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br><span class="line">or</span><br><span class="line"><span class="built_in">source</span> ~/.bash_profile</span><br></pre></td></tr></table></figure><hr><h2><span id="bower">Bower</span></h2><p>There is no command line that I found for configuring bower. Instead you need to create a <code>.bowerrc</code> file in the users home directory.</p><p>On Windows: <code>%userprofile%</code> directory.</p><p>On Linux: <code>~/</code></p><h3><span id="creating-bowerrc-file-on-windows">Creating .bowerrc file on Windows</span></h3><p>Windows Explorer unfortunately does not allow you to create files without extensions but using notepad you can create a file without an extension.</p><pre><code>1. Open Notepad2. Ctrl + S to save the file3. Navigate to the %UserProfile% directory4. Change the &quot;Save as Type&quot; to &quot;All Files (_._)5. Name the file .bowerrc6. Click the Save button7. Now you can edit the file in your text editor of choice</code></pre><h3><span id="proxy-setting-in-bowerrc">Proxy Setting in .bowerrc.</span></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="string">"proxy"</span>:<span class="string">"http://[Your Proxy]:[Proxy Port]"</span>,</span><br><span class="line"><span class="string">"https-proxy"</span>:<span class="string">"http://[Your Proxy]:[Proxy Port]"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2><span id="git">Git</span></h2><p>You can also set the proxy settings below to be system wide with the <code>–system</code> switch.</p><h3><span id="set-proxy">Set Proxy</span></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config --add http.proxy http://[Your Proxy]:[Proxy Port]</span><br><span class="line">git config --add https.proxy http://[Your Proxy]:[Proxy Port]</span><br></pre></td></tr></table></figure><h3><span id="unset-proxy">Unset Proxy</span></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config --<span class="built_in">unset</span> http.proxy</span><br><span class="line">git config --<span class="built_in">unset</span> https.proxy</span><br></pre></td></tr></table></figure><h3><span id="view-configuration">View Configuration</span></h3><p><strong>Just Proxy Configs</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config --get http.proxy</span><br><span class="line">git config --get https.proxy</span><br></pre></td></tr></table></figure><p><strong>All Configs</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git config --list</span><br></pre></td></tr></table></figure><h3><span id="manually-update-gitconfig-not-recommended">Manually Update .gitconfig (not recommended)</span></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[http]</span><br><span class="line">proxy = http://[Your Proxy]:[Proxy Port]</span><br><span class="line">[https]</span><br><span class="line">proxy = http://[Your Proxy]:[Proxy Port]</span><br></pre></td></tr></table></figure><hr><h2><span id="npm">NPM</span></h2><h3><span id="set-proxy">Set Proxy</span></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm config <span class="built_in">set</span> https-proxy http://[Your Proxy]:[Proxy Port]</span><br><span class="line">npm config <span class="built_in">set</span> proxy http://[Your Proxy]:[Proxy Port]</span><br></pre></td></tr></table></figure><h3><span id="unset-proxy">Unset Proxy</span></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm config delete https-proxy</span><br><span class="line">npm config delete proxy</span><br></pre></td></tr></table></figure><h3><span id="view-proxy-configurations">View Proxy Configurations</span></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm config get https-proxy</span><br><span class="line">npm config get proxy</span><br></pre></td></tr></table></figure><h3><span id="manually-update-npmrc-not-recommended">Manually Update .npmrc (not recommended)</span></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">proxy=http://[Your Proxy]:[Proxy Port]</span><br><span class="line">https-proxy=http://[Your Proxy]:[Proxy Port]</span><br></pre></td></tr></table></figure><hr><h2><span id="ruby-gem-install">Ruby Gem Install</span></h2><p>If you have set the proxy in the <code>.bash_profile</code> or <code>.bashrc</code>, then Ruby should pick it up.</p><p>If you need to manually set it</p><h3><span id="linux">Linux</span></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> http_proxy=[Your Proxy]:[Proxy Port]</span><br><span class="line">sudo gem install [your gem name]</span><br></pre></td></tr></table></figure><h3><span id="windows">Windows</span></h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setx http_proxy "[Your Proxy Server]:[Proxy Port]" /M</span><br><span class="line">gem install [your gem name]</span><br></pre></td></tr></table></figure><hr><h2><span id="ionic-start-command">Ionic Start Command</span></h2><p>In order to run the <code>ionic start</code> command behind a proxy, you need start the command out with the Proxy information.</p><h3><span id="linux">Linux</span></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PROXY=http://[Your Proxy]:[Proxy Port] ionic start [App Name] [Template Name]</span><br></pre></td></tr></table></figure><h3><span id="windows">Windows</span></h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setx http_proxy "[Your Proxy Server]:[Proxy Port]" /M</span><br><span class="line">ionic <span class="built_in">start</span> [App Name] [Template Name]</span><br></pre></td></tr></table></figure><hr><h2><span id="android-sdk">Android SDK</span></h2><p>The android SDK uses <code>~/.android/androidtool.cfg</code> file to define the proxy information. If the file does not exist, go ahead and create it.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http.proxyHost=[Your Proxy]</span><br><span class="line">http.proxyPort=[Proxy Port]</span><br></pre></td></tr></table></figure><hr><h2><span id="gradle">Gradle</span></h2><p>When trying to build an Android project that uses Gradle, you may need to configure the proxy for it.</p><p>On Windows: <code>%userprofile%/.gradle.properties</code></p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">systemProp.http.proxyHost=[Your Proxy]</span><br><span class="line">systemProp.http.proxyPort=[Proxy Port]</span><br><span class="line">systemProp.http.nonProxyHosts=*.nonproxyrepos.com|localhost</span><br><span class="line"></span><br><span class="line">systemProp.https.proxyHost=[Your Https Proxy]</span><br><span class="line">systemProp.https.proxyPort=[Https Proxy Port]</span><br><span class="line">systemProp.https.nonProxyHosts=*.nonproxyrepos.com|localhost</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Npm, Bower, Git, and Bash Proxy Configurations&lt;/strong&gt;&lt;br&gt;Original Post: &lt;a href=&quot;http://digitaldrummerj.me/proxy-configurations/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;http://digitaldrummerj.me/proxy-configurations/&lt;/a&gt; on &lt;code&gt;2015-08-03&lt;/code&gt;&lt;br&gt;Copyright © &lt;a href=&quot;http://digitaldrummerj.me/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;&lt;strong&gt;Justin James&lt;/strong&gt;&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;When you are using npm, bower, and git behind a proxy server you have to do a little bit of configuration. Luckily it is super easy to do these configurations. Almost all of the programs have command line commands to set and unset the proxy server.&lt;/p&gt;
&lt;h2 id=&quot;Updates&quot;&gt;&lt;a href=&quot;#Updates&quot; class=&quot;headerlink&quot; title=&quot;Updates&quot;&gt;&lt;/a&gt;Updates&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Updated 2015-Feb-01&lt;/strong&gt;: Added running source command for Bash and Ruby Gems section&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Updated 2015-May-07&lt;/strong&gt;: Added the Ionic Start command&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Updated 2015-May-08&lt;/strong&gt;: Added the Android SDK&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Updated 2015-Aug-03&lt;/strong&gt;: Added command lines to set proxy&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Updated 2015-Oct-20&lt;/strong&gt;: Added Gradle&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;Windows-Command-Prompt&quot;&gt;&lt;a href=&quot;#Windows-Command-Prompt&quot; class=&quot;headerlink&quot; title=&quot;Windows Command Prompt&quot;&gt;&lt;/a&gt;Windows Command Prompt&lt;/h2&gt;&lt;h3 id=&quot;Current-Command-Prompt-Only&quot;&gt;&lt;a href=&quot;#Current-Command-Prompt-Only&quot; class=&quot;headerlink&quot; title=&quot;Current Command Prompt Only&quot;&gt;&lt;/a&gt;Current Command Prompt Only&lt;/h3&gt;&lt;figure class=&quot;highlight cmd&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;set&lt;/span&gt; http_proxy=[Your Proxy]:[Proxy Port]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;set&lt;/span&gt; https_proxy=[Your Proxy]:[Proxy Port]&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;Unset-Current-Session&quot;&gt;&lt;a href=&quot;#Unset-Current-Session&quot; class=&quot;headerlink&quot; title=&quot;Unset Current Session&quot;&gt;&lt;/a&gt;Unset Current Session&lt;/h3&gt;&lt;figure class=&quot;highlight cmd&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;set&lt;/span&gt; http_proxy=&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;set&lt;/span&gt; https_proxy=&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="他山之石" scheme="http://xiao-fang.cc/categories/%E4%BB%96%E5%B1%B1%E4%B9%8B%E7%9F%B3/"/>
    
    
      <category term="Git" scheme="http://xiao-fang.cc/tags/Git/"/>
    
      <category term="Proxy" scheme="http://xiao-fang.cc/tags/Proxy/"/>
    
      <category term="NPM" scheme="http://xiao-fang.cc/tags/NPM/"/>
    
      <category term="Bash" scheme="http://xiao-fang.cc/tags/Bash/"/>
    
      <category term="Bower" scheme="http://xiao-fang.cc/tags/Bower/"/>
    
      <category term="NodeJs" scheme="http://xiao-fang.cc/tags/NodeJs/"/>
    
  </entry>
  
  <entry>
    <title>Pretty Git Log</title>
    <link href="http://xiao-fang.cc/2017/06/06/git-tips-pretty-git-log/"/>
    <id>http://xiao-fang.cc/2017/06/06/git-tips-pretty-git-log/</id>
    <published>2017-06-06T00:00:00.000Z</published>
    <updated>2020-11-16T01:47:12.577Z</updated>
    
    <content type="html"><![CDATA[<h3><span id="git-log"><code>git log</code></span></h3><p><code>git log</code> is the command to list git change history. the default <code>git log</code> console output is not that pretty as following.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">log</span> --max-count=5</span><br></pre></td></tr></table></figure><pre style="background-color: #272822">    <span style="color: #CACACA;background-color: #272822;"></span>    <span style="color: #8DD006;background-color: #272822;">C:\Workspace\xiao-fang.github.io </span><span style="color: #F3044B;background-color: #272822;">(hexo) </span><span style="color: #CACACA;background-color: #272822;"></span>    <span style="color: #7C7C7C;background-color: #272822;">λ </span><span style="color: #CACACA;background-color: #272822;">git log --max-count=5 </span>    <span style="color: #B6B649;background-color: #272822;">commit f4f30751999a62428347a3681f3dea175d6301d2</span><span style="color: #CACACA;background-color: #272822;"></span>    <span style="color: #CACACA;background-color: #272822;">Author: xiao-fang &lt;xf@xxmail.com&gt;</span>    <span style="color: #CACACA;background-color: #272822;">Date: Mon Jun 5 16:47:28 2017 +0800 </span>    <span style="color: #CACACA;background-color: #272822;"></span>    <span style="color: #CACACA;background-color: #272822;">add a new post 'pretty git log', and update an old post </span>    <span style="color: #CACACA;background-color: #272822;"></span>    <span style="color: #B6B649;background-color: #272822;">commit 9c883d710af69845cce226632cdd7bb361fbab3c</span><span style="color: #CACACA;background-color: #272822;"></span>    <span style="color: #CACACA;background-color: #272822;">Author: xiao-fang &lt;xf@xxmail.com&gt;</span>    <span style="color: #CACACA;background-color: #272822;">Date: Fri Jun 2 18:16:08 2017 +0800 </span>    <span style="color: #CACACA;background-color: #272822;"></span>    <span style="color: #CACACA;background-color: #272822;">update adminKey for algolia with TRAVIS env var. </span>    <span style="color: #CACACA;background-color: #272822;"></span>    <span style="color: #B6B649;background-color: #272822;">commit a6e7c00d6200629f62a9d402659a2910d5beda44</span><span style="color: #CACACA;background-color: #272822;"></span>    <span style="color: #CACACA;background-color: #272822;">Author: xiao-fang &lt;xf@xxmail.com&gt;</span>    <span style="color: #CACACA;background-color: #272822;">Date: Fri Jun 2 18:02:53 2017 +0800 </span>    <span style="color: #CACACA;background-color: #272822;"></span>    <span style="color: #CACACA;background-color: #272822;">update adminKey for algolia. </span>    <span style="color: #CACACA;background-color: #272822;"></span>    <span style="color: #B6B649;background-color: #272822;">commit 579b0cab229fe60000dfda03bc2d935bfa742ce3</span><span style="color: #CACACA;background-color: #272822;"></span>    <span style="color: #CACACA;background-color: #272822;">Author: xiao-fang &lt;xf@xxmail.com&gt;</span>    <span style="color: #CACACA;background-color: #272822;">Date: Fri Jun 2 17:14:55 2017 +0800 </span>    <span style="color: #CACACA;background-color: #272822;"></span>    <span style="color: #CACACA;background-color: #272822;">integrated 'hexo-algolia' search feature. update algolia version from 1.01. to 0.2.0 </span>    <span style="color: #CACACA;background-color: #272822;"></span>    <span style="color: #B6B649;background-color: #272822;">commit 233120a04db71f3eca60f3524e0cab287f302b4c</span><span style="color: #CACACA;background-color: #272822;"></span>    <span style="color: #CACACA;background-color: #272822;">Author: xiao-fang &lt;xf@xxmail.com&gt;</span>    <span style="color: #CACACA;background-color: #272822;">Date: Fri Jun 2 17:05:59 2017 +0800 </span>    <span style="color: #CACACA;background-color: #272822;"></span>    <span style="color: #CACACA;background-color: #272822;">integrated 'hexo-algolia' search feature. </span><br></pre><a id="more"></a><h3><span id="git-pretty-log">git <code>Pretty</code> log</span></h3><p>here is my <code>git log pretty scheme</code>, let’s compare it with <code>git log</code> default output style.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git config --global alias.hist <span class="string">"log --pretty=format:'%C(yellow)[%ad]%C(reset) %C(green)[%h]%C(reset) | %s %C(bold red)%d%C(reset) %C(green)[%an]%C(reset)' --graph --date=short"</span></span><br></pre></td></tr></table></figure></p><p>looks like as following.</p><pre style="background-color: #272822">    <br>    <span style="color: #8DD006; background-color: #272822; ">C:\Workspace\xiao-fang.github.io </span><span style="color: #F3044B; background-color: #272822; ">(hexo) </span><span style="color: #CACACA; background-color: #272822; "></span>    <span style="color: #7C7C7C; background-color: #272822; ">λ </span><span style="color: #CACACA; background-color: #272822; ">git hist --max-count=20 </span>    <span style="color: #CACACA; background-color: #272822; ">* </span><span style="color: #B6B649; background-color: #272822; ">[2017-06-02]</span><span style="color: #CACACA; background-color: #272822; "></span><span style="color: #74AA04; background-color: #272822; ">[9c883d7]</span><span style="color: #CACACA; background-color: #272822; ">| update adminKey for algolia with TRAVIS env var. </span><span style="color: #F3044B; background-color: #272822; ">(HEAD -&gt; hexo, origin/hexo)</span><span style="color: #CACACA; background-color: #272822; "></span><span style="color: #74AA04; background-color: #272822; ">[xiao-fang]</span><span style="color: #CACACA; background-color: #272822; "></span>    <span style="color: #CACACA; background-color: #272822; ">* </span><span style="color: #B6B649; background-color: #272822; ">[2017-06-02]</span><span style="color: #CACACA; background-color: #272822; "></span><span style="color: #74AA04; background-color: #272822; ">[a6e7c00]</span><span style="color: #CACACA; background-color: #272822; ">| update adminKey for algolia. </span><span style="color: #74AA04; background-color: #272822; ">[xiao-fang]</span><span style="color: #CACACA; background-color: #272822; "></span>    <span style="color: #CACACA; background-color: #272822; ">* </span><span style="color: #B6B649; background-color: #272822; ">[2017-06-02]</span><span style="color: #CACACA; background-color: #272822; "></span><span style="color: #74AA04; background-color: #272822; ">[579b0ca]</span><span style="color: #CACACA; background-color: #272822; ">| integrated 'hexo-algolia' search feature. update algolia version from 1.01. to 0.2.0 </span><span style="color: #74AA04; background-color: #272822; ">[xiao-fang]</span><span style="color: #CACACA; background-color: #272822; "></span>    <span style="color: #CACACA; background-color: #272822; ">* </span><span style="color: #B6B649; background-color: #272822; ">[2017-06-02]</span><span style="color: #CACACA; background-color: #272822; "></span><span style="color: #74AA04; background-color: #272822; ">[233120a]</span><span style="color: #CACACA; background-color: #272822; ">| integrated 'hexo-algolia' search feature. </span><span style="color: #74AA04; background-color: #272822; ">[xiao-fang]</span><span style="color: #CACACA; background-color: #272822; "></span>    <span style="color: #CACACA; background-color: #272822; ">* </span><span style="color: #B6B649; background-color: #272822; ">[2017-06-02]</span><span style="color: #CACACA; background-color: #272822; "></span><span style="color: #74AA04; background-color: #272822; ">[eaaccc9]</span><span style="color: #CACACA; background-color: #272822; ">| move 'clr-via-cs-01' from _posts to _drafts. </span><span style="color: #74AA04; background-color: #272822; ">[xiao-fang]</span><span style="color: #CACACA; background-color: #272822; "></span>    <span style="color: #CACACA; background-color: #272822; ">* </span><span style="color: #B6B649; background-color: #272822; ">[2017-06-02]</span><span style="color: #CACACA; background-color: #272822; "></span><span style="color: #74AA04; background-color: #272822; ">[bdc542d]</span><span style="color: #CACACA; background-color: #272822; ">| add 'server-world.info' homepage link. </span><span style="color: #74AA04; background-color: #272822; ">[xiao-fang]</span><span style="color: #CACACA; background-color: #272822; "></span>    <span style="color: #CACACA; background-color: #272822; ">* </span><span style="color: #B6B649; background-color: #272822; ">[2017-06-02]</span><span style="color: #CACACA; background-color: #272822; "></span><span style="color: #74AA04; background-color: #272822; ">[9b8beaf]</span><span style="color: #CACACA; background-color: #272822; ">| update 'window-threading' post </span><span style="color: #74AA04; background-color: #272822; ">[xiao-fang]</span><span style="color: #CACACA; background-color: #272822; "></span>    <span style="color: #CACACA; background-color: #272822; ">* </span><span style="color: #B6B649; background-color: #272822; ">[2017-06-02]</span><span style="color: #CACACA; background-color: #272822; "></span><span style="color: #74AA04; background-color: #272822; ">[3a95f39]</span><span style="color: #CACACA; background-color: #272822; ">| update header/content-wrapper width to 80% </span><span style="color: #74AA04; background-color: #272822; ">[xiao-fang]</span><span style="color: #CACACA; background-color: #272822; "></span>    <span style="color: #CACACA; background-color: #272822; ">* </span><span style="color: #B6B649; background-color: #272822; ">[2017-06-02]</span><span style="color: #CACACA; background-color: #272822; "></span><span style="color: #74AA04; background-color: #272822; ">[6301b70]</span><span style="color: #CACACA; background-color: #272822; ">| update header/content-wrapper width to 80% </span><span style="color: #74AA04; background-color: #272822; ">[xiao-fang]</span><span style="color: #CACACA; background-color: #272822; "></span>    <span style="color: #CACACA; background-color: #272822; ">* </span><span style="color: #B6B649; background-color: #272822; ">[2017-06-02]</span><span style="color: #CACACA; background-color: #272822; "></span><span style="color: #74AA04; background-color: #272822; ">[96bfa34]</span><span style="color: #CACACA; background-color: #272822; ">| update window-thread post, table </span><span style="color: #74AA04; background-color: #272822; ">[xiao-fang]</span><span style="color: #CACACA; background-color: #272822; "></span>    <span style="color: #CACACA; background-color: #272822; ">* </span><span style="color: #B6B649; background-color: #272822; ">[2017-06-02]</span><span style="color: #CACACA; background-color: #272822; "></span><span style="color: #74AA04; background-color: #272822; ">[be2aaac]</span><span style="color: #CACACA; background-color: #272822; ">| update table-layout: fixed to auto </span><span style="color: #74AA04; background-color: #272822; ">[xiao-fang]</span><span style="color: #CACACA; background-color: #272822; "></span>    <span style="color: #CACACA; background-color: #272822; ">* </span><span style="color: #B6B649; background-color: #272822; ">[2017-06-02]</span><span style="color: #CACACA; background-color: #272822; "></span><span style="color: #74AA04; background-color: #272822; ">[97387fd]</span><span style="color: #CACACA; background-color: #272822; ">| turn off animation. </span><span style="color: #74AA04; background-color: #272822; ">[xiao-fang]</span><span style="color: #CACACA; background-color: #272822; "></span>    <span style="color: #CACACA; background-color: #272822; ">* </span><span style="color: #B6B649; background-color: #272822; ">[2017-06-02]</span><span style="color: #CACACA; background-color: #272822; "></span><span style="color: #74AA04; background-color: #272822; ">[5f7401b]</span><span style="color: #CACACA; background-color: #272822; ">| update `windows threading` post </span><span style="color: #74AA04; background-color: #272822; ">[xiao-fang]</span><span style="color: #CACACA; background-color: #272822; "></span>    <span style="color: #CACACA; background-color: #272822; ">* </span><span style="color: #B6B649; background-color: #272822; ">[2017-05-26]</span><span style="color: #CACACA; background-color: #272822; "></span><span style="color: #74AA04; background-color: #272822; ">[232e708]</span><span style="color: #CACACA; background-color: #272822; ">| update `windows threading` post </span><span style="color: #74AA04; background-color: #272822; ">[xiao-fang]</span><span style="color: #CACACA; background-color: #272822; "></span>    <span style="color: #CACACA; background-color: #272822; ">* </span><span style="color: #B6B649; background-color: #272822; ">[2017-05-26]</span><span style="color: #CACACA; background-color: #272822; "></span><span style="color: #74AA04; background-color: #272822; ">[adc8be1]</span><span style="color: #CACACA; background-color: #272822; ">| update `windows threading` post </span><span style="color: #74AA04; background-color: #272822; ">[xiao-fang]</span><span style="color: #CACACA; background-color: #272822; "></span>    <span style="color: #CACACA; background-color: #272822; ">* </span><span style="color: #B6B649; background-color: #272822; ">[2017-05-22]</span><span style="color: #CACACA; background-color: #272822; "></span><span style="color: #74AA04; background-color: #272822; ">[a6028dc]</span><span style="color: #CACACA; background-color: #272822; ">| update draft post 'clr via cs - execution model' typo issue </span><span style="color: #74AA04; background-color: #272822; ">[xiao-fang]</span><span style="color: #CACACA; background-color: #272822; "></span>    <span style="color: #CACACA; background-color: #272822; ">* </span><span style="color: #B6B649; background-color: #272822; ">[2017-05-22]</span><span style="color: #CACACA; background-color: #272822; "></span><span style="color: #74AA04; background-color: #272822; ">[5ba5652]</span><span style="color: #CACACA; background-color: #272822; ">| update draft post 'clr via cs - execution model' resources </span><span style="color: #74AA04; background-color: #272822; ">[xiao-fang]</span><span style="color: #CACACA; background-color: #272822; "></span>    <span style="color: #CACACA; background-color: #272822; ">* </span><span style="color: #B6B649; background-color: #272822; ">[2017-05-22]</span><span style="color: #CACACA; background-color: #272822; "></span><span style="color: #74AA04; background-color: #272822; ">[2c59263]</span><span style="color: #CACACA; background-color: #272822; ">| update draft post 'windows threading'; add new draft post 'clr via cs - execution model' </span><span style="color: #74AA04; background-color: #272822; ">[xiao-fang]</span><span style="color: #CACACA; background-color: #272822; "></span>    <span style="color: #CACACA; background-color: #272822; ">* </span><span style="color: #B6B649; background-color: #272822; ">[2017-05-17]</span><span style="color: #CACACA; background-color: #272822; "></span><span style="color: #74AA04; background-color: #272822; ">[8445888]</span><span style="color: #CACACA; background-color: #272822; ">| update draft post 'windows threading' </span><span style="color: #74AA04; background-color: #272822; ">[xiao-fang]</span><span style="color: #CACACA; background-color: #272822; "></span>    <span style="color: #CACACA; background-color: #272822; ">* </span><span style="color: #B6B649; background-color: #272822; ">[2017-05-17]</span><span style="color: #CACACA; background-color: #272822; "></span><span style="color: #74AA04; background-color: #272822; ">[3e39b9a]</span><span style="color: #CACACA; background-color: #272822; ">| update draft post 'windows threading' </span><span style="color: #74AA04; background-color: #272822; ">[xiao-fang]</span><span style="color: #CACACA; background-color: #272822; "></span>    <br></pre><h3><span id="reference">Reference</span></h3><ul><li><p><a href="https://git-scm.com/book/en/v2/Git-Basics-Viewing-the-Commit-History" target="_blank" rel="noopener">2.3 Git Basics - Viewing the Commit History</a></p></li><li><p><a href="https://git-scm.com/docs/pretty-formats" target="_blank" rel="noopener">Git History with Pretty Format</a></p></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;git-log&quot;&gt;&lt;a href=&quot;#git-log&quot; class=&quot;headerlink&quot; title=&quot;git log&quot;&gt;&lt;/a&gt;&lt;code&gt;git log&lt;/code&gt;&lt;/h3&gt;&lt;p&gt;&lt;code&gt;git log&lt;/code&gt; is the command to list git change history. the default &lt;code&gt;git log&lt;/code&gt; console output is not that pretty as following.&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;git &lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt; --max-count=5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;pre style=&quot;background-color: #272822&quot;&gt;
    &lt;span style=&quot;color: #CACACA;background-color: #272822;&quot;&gt;&lt;/span&gt;
    &lt;span style=&quot;color: #8DD006;background-color: #272822;&quot;&gt;C:\Workspace\xiao-fang.github.io &lt;/span&gt;&lt;span style=&quot;color: #F3044B;background-color: #272822;&quot;&gt;(hexo) &lt;/span&gt;&lt;span style=&quot;color: #CACACA;background-color: #272822;&quot;&gt;&lt;/span&gt;
    &lt;span style=&quot;color: #7C7C7C;background-color: #272822;&quot;&gt;λ &lt;/span&gt;&lt;span style=&quot;color: #CACACA;background-color: #272822;&quot;&gt;git log --max-count=5 &lt;/span&gt;
    &lt;span style=&quot;color: #B6B649;background-color: #272822;&quot;&gt;commit f4f30751999a62428347a3681f3dea175d6301d2&lt;/span&gt;&lt;span style=&quot;color: #CACACA;background-color: #272822;&quot;&gt;&lt;/span&gt;
    &lt;span style=&quot;color: #CACACA;background-color: #272822;&quot;&gt;Author: xiao-fang &amp;lt;xf@xxmail.com&amp;gt;&lt;/span&gt;
    &lt;span style=&quot;color: #CACACA;background-color: #272822;&quot;&gt;Date: Mon Jun 5 16:47:28 2017 +0800 &lt;/span&gt;
    &lt;span style=&quot;color: #CACACA;background-color: #272822;&quot;&gt;&lt;/span&gt;
    &lt;span style=&quot;color: #CACACA;background-color: #272822;&quot;&gt;add a new post &#39;pretty git log&#39;, and update an old post &lt;/span&gt;
    &lt;span style=&quot;color: #CACACA;background-color: #272822;&quot;&gt;&lt;/span&gt;
    &lt;span style=&quot;color: #B6B649;background-color: #272822;&quot;&gt;commit 9c883d710af69845cce226632cdd7bb361fbab3c&lt;/span&gt;&lt;span style=&quot;color: #CACACA;background-color: #272822;&quot;&gt;&lt;/span&gt;
    &lt;span style=&quot;color: #CACACA;background-color: #272822;&quot;&gt;Author: xiao-fang &amp;lt;xf@xxmail.com&amp;gt;&lt;/span&gt;
    &lt;span style=&quot;color: #CACACA;background-color: #272822;&quot;&gt;Date: Fri Jun 2 18:16:08 2017 +0800 &lt;/span&gt;
    &lt;span style=&quot;color: #CACACA;background-color: #272822;&quot;&gt;&lt;/span&gt;
    &lt;span style=&quot;color: #CACACA;background-color: #272822;&quot;&gt;update adminKey for algolia with TRAVIS env var. &lt;/span&gt;
    &lt;span style=&quot;color: #CACACA;background-color: #272822;&quot;&gt;&lt;/span&gt;
    &lt;span style=&quot;color: #B6B649;background-color: #272822;&quot;&gt;commit a6e7c00d6200629f62a9d402659a2910d5beda44&lt;/span&gt;&lt;span style=&quot;color: #CACACA;background-color: #272822;&quot;&gt;&lt;/span&gt;
    &lt;span style=&quot;color: #CACACA;background-color: #272822;&quot;&gt;Author: xiao-fang &amp;lt;xf@xxmail.com&amp;gt;&lt;/span&gt;
    &lt;span style=&quot;color: #CACACA;background-color: #272822;&quot;&gt;Date: Fri Jun 2 18:02:53 2017 +0800 &lt;/span&gt;
    &lt;span style=&quot;color: #CACACA;background-color: #272822;&quot;&gt;&lt;/span&gt;
    &lt;span style=&quot;color: #CACACA;background-color: #272822;&quot;&gt;update adminKey for algolia. &lt;/span&gt;
    &lt;span style=&quot;color: #CACACA;background-color: #272822;&quot;&gt;&lt;/span&gt;
    &lt;span style=&quot;color: #B6B649;background-color: #272822;&quot;&gt;commit 579b0cab229fe60000dfda03bc2d935bfa742ce3&lt;/span&gt;&lt;span style=&quot;color: #CACACA;background-color: #272822;&quot;&gt;&lt;/span&gt;
    &lt;span style=&quot;color: #CACACA;background-color: #272822;&quot;&gt;Author: xiao-fang &amp;lt;xf@xxmail.com&amp;gt;&lt;/span&gt;
    &lt;span style=&quot;color: #CACACA;background-color: #272822;&quot;&gt;Date: Fri Jun 2 17:14:55 2017 +0800 &lt;/span&gt;
    &lt;span style=&quot;color: #CACACA;background-color: #272822;&quot;&gt;&lt;/span&gt;
    &lt;span style=&quot;color: #CACACA;background-color: #272822;&quot;&gt;integrated &#39;hexo-algolia&#39; search feature. update algolia version from 1.01. to 0.2.0 &lt;/span&gt;
    &lt;span style=&quot;color: #CACACA;background-color: #272822;&quot;&gt;&lt;/span&gt;
    &lt;span style=&quot;color: #B6B649;background-color: #272822;&quot;&gt;commit 233120a04db71f3eca60f3524e0cab287f302b4c&lt;/span&gt;&lt;span style=&quot;color: #CACACA;background-color: #272822;&quot;&gt;&lt;/span&gt;
    &lt;span style=&quot;color: #CACACA;background-color: #272822;&quot;&gt;Author: xiao-fang &amp;lt;xf@xxmail.com&amp;gt;&lt;/span&gt;
    &lt;span style=&quot;color: #CACACA;background-color: #272822;&quot;&gt;Date: Fri Jun 2 17:05:59 2017 +0800 &lt;/span&gt;
    &lt;span style=&quot;color: #CACACA;background-color: #272822;&quot;&gt;&lt;/span&gt;
    &lt;span style=&quot;color: #CACACA;background-color: #272822;&quot;&gt;integrated &#39;hexo-algolia&#39; search feature. &lt;/span&gt;
&lt;br&gt;
&lt;/pre&gt;
    
    </summary>
    
      <category term="拾遗补阙" scheme="http://xiao-fang.cc/categories/%E6%8B%BE%E9%81%97%E8%A1%A5%E9%98%99/"/>
    
    
      <category term="Git" scheme="http://xiao-fang.cc/tags/Git/"/>
    
      <category term="Tips" scheme="http://xiao-fang.cc/tags/Tips/"/>
    
  </entry>
  
  <entry>
    <title>少年游</title>
    <link href="http://xiao-fang.cc/2017/06/02/poem-shaonian-you/"/>
    <id>http://xiao-fang.cc/2017/06/02/poem-shaonian-you/</id>
    <published>2017-06-02T00:00:00.000Z</published>
    <updated>2020-11-16T01:47:12.577Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>丁酉(2017)正月初十, 年节初过, 背井离乡少年游.<br>by 一粟生</p></blockquote><blockquote class="blockquote-center"><br><b>少年游</b><br>天朗气清近午天, 小别英山向武汉.<br>年节虽好匆匆过, 游必有方正少年.<br></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;丁酉(2017)正月初十, 年节初过, 背井离乡少年游.&lt;br&gt;by 一粟生&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote class=&quot;blockquote-center&quot;&gt;&lt;br&gt;&lt;b&gt;少年游&lt;/b&gt;&lt;br&gt;天朗气清近午天, 小别
      
    
    </summary>
    
      <category term="闲言随笔" scheme="http://xiao-fang.cc/categories/%E9%97%B2%E8%A8%80%E9%9A%8F%E7%AC%94/"/>
    
    
  </entry>
  
  <entry>
    <title>Windows Thread</title>
    <link href="http://xiao-fang.cc/2017/05/17/windows-thread/"/>
    <id>http://xiao-fang.cc/2017/05/17/windows-thread/</id>
    <published>2017-05-17T00:00:00.000Z</published>
    <updated>2020-11-16T01:47:12.577Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>DRAFT VERSION</p></blockquote><h2><span id="thread-basic">Thread Basic</span></h2><h3><span id="background">Background</span></h3><p>OS only one <code>Thread</code> of execution that ran through the entire system.</p><ul><li>includes both OS code/data and application code/data</li><li>exclusive, prevent other tasks from executing</li><li>application may cause infinite loop and block entire OS</li></ul><h3><span id="process">Process</span></h3><ul><li>each instance of application is a <code>process</code></li><li><code>process</code> is a collection of resources that’s used by a single instance of application</li><li>virtual address space, isolated domain protection</li><li>depends on and limit to CPU cores</li><li><code>process</code> is expensive in Windows, it may take several seconds to create a process (allocate &amp; initialize memory, load exe/dll for disk, etc.)</li></ul><a id="more"></a><h3><span id="thread">Thread</span></h3><ul><li><p>every <code>Thread</code> has each of following: <code>Thread Kernal Object</code>, <code>Thread Environment Block (TEB)</code>, <code>User-mode Stack</code>, <code>Kernal-mode Stack</code>, <code>DLL thread-attach and thread-detach notifications</code>(unmanaged programming only). =&gt; all these would be allocated when creating a thread =&gt; so a thread itself may take some momery space (at least 1MB+ per thread).</p></li><li><p><code>context switching</code>, CPU has fixed number cores, that threads size may far greater than CPU core number, that CPU allow a thread to run for a <strong><code>time-slice</code></strong>. (<strong>Because CPU core can only do one thine at a time</strong>). Whenever the <code>time-slice</code> for a thread expires, that <code>Windows Context</code> switches to another thread.</p></li><li><code>Thread</code> is the basic dispatcher unit by CPU.</li><li><code>optimum number of threads</code> is the number of CPU cores. (since there’s no context switching, and threads run at full speed)</li><li>don’t <code>abuse</code> thread, <strong>stop the madness!</strong></li><li>don’t <code>block</code> thread, should perform async operations</li></ul><h3><span id="clr-threads-vs-windows-threads">CLR Threads vs Windows Threads</span></h3><ul><li>a CLR thread is identical to a Windows Thread</li></ul><h3><span id="brief">Brief</span></h3><ul><li>进程(<code>Process</code>)是运行程序的实例; 内存空间独立; ( =&gt; 进程通信);</li><li>线程(<code>Thread</code>)是CPU的基本调度单元; 内存空间共享; ( =&gt; 线程同步);</li></ul><h3><span id="two-kind-of-async-operations">Two kind of Async Operations:</span></h3><ul><li><code>Compute-Bound</code>:  requires a thread to do the work</li><li><code>I/O-Bound</code>:  device driver has hardware to do the work; no thread required.</li></ul><h3><span id="thread-schedule-and-priorities">Thread Schedule and Priorities</span></h3><ul><li>Windows is <strong>NOT</strong> a <code>Real-Time Operating System</code></li><li>Every thread is assigned a priority level ranging from <code>0 (the lowest)</code> to <code>31 (the highest)</code></li><li>Higher-priority threads always <code>preempt</code>(抢占) lower-priority threads, regardless of what the lower-priority threads are executing.</li><li>A <code>zero page thread</code> creates on system boot, the lowest priority, when there’s no any other high priority threads need to work, so it’s turn to work, <code>to zeroing any free pages of RAM in system</code>. ( <code>priority 0 is reserved ofor the zero page thread</code>)</li><li>Process Priority and Relative Thread Priority Mapping</li></ul><table><thead><tr><th>Thread / Process</th><th>Real Time</th><th>High</th><th>Above Normal</th><th>Normal</th><th>Below Normal</th><th>Idle</th></tr></thead><tbody><tr><td>Time Critical</td><td>31</td><td>15</td><td>15</td><td>15</td><td>15</td><td>15</td></tr><tr><td>Highest</td><td>26</td><td>15</td><td>12</td><td>10</td><td>8</td><td>6</td></tr><tr><td>Above Normal</td><td>25</td><td>14</td><td>11</td><td>9</td><td>7</td><td>5</td></tr><tr><td>Normal</td><td>24</td><td>13</td><td>10</td><td>8</td><td>6</td><td>4</td></tr><tr><td>Below Normal</td><td>23</td><td>12</td><td>9</td><td>7</td><td>5</td><td>3</td></tr><tr><td>Lowest</td><td>22</td><td>11</td><td>8</td><td>6</td><td>4</td><td>2</td></tr><tr><td>Idle</td><td>16</td><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td></tr></tbody></table><h3><span id="foregroud-threads-vs-backgroud-threads">Foregroud Threads vs. Backgroud Threads</span></h3><ul><li>CLR consider every thread to be either a foregroud or a backgroud thread.</li><li>When all foreground threads in a process stop running, then CLR force stops any backgroud threads regardless if background threads are still running.</li></ul><h2><span id="compute-bound-async-operations">Compute-Bound Async Operations</span></h2><h3><span id="thread-pool">Thread Pool</span></h3><ul><li>why threads should be improved?<ul><li>creating/destroying a thread is an expensive operation in terms of time</li><li>having a lot of threads wastes memory resource and impact on performance because of context switching between threads.</li></ul></li><li>How <code>ThreadPool</code> works?<ul><li><code>initialize</code> with CLR, <code>one</code> ThreadPool per CLR</li><li>internally, the thread pool maintains a <code>queue</code> of operation requests</li><li>whatever application can <code>append requests</code> in queue by call some ThreadPool method</li><li>requests in thread pool queue would be <code>run</code> in some order by time or priority</li><li>thread pool <code>reuse</code> threads</li><li>thread pool <code>create more threads</code> if there are many requests, otherwise if requests decrese, the thread pool <code>threads kill themselves</code>.</li></ul></li><li><p>Practice</p>  <figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> Boolean <span class="title">QueueUserWorkItem</span>(<span class="params">WaitCallback callBack</span>)</span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> Boolean <span class="title">QueueUserWorkItem</span>(<span class="params">WaitCallback callBack, Object state</span>)</span>;</span><br></pre></td></tr></table></figure></li><li><p>Limitations</p><ul><li><code>Thread Pool</code>, that there’s no build-in way for operation completed callback.</li></ul></li></ul><h3><span id="execution-contexts">Execution Contexts</span></h3><ul><li>every thread has an <code>execution context</code> associated to it.</li><li><code>execution context</code> includes such as,<ul><li>security settings (compressed stack, Thread’s Principal property, and Windows identity)</li><li>host settings (see System.Threading.HostExecutionContextManager)</li><li>logical call context data (see System.Runtime.Remoting.Messaging.CallContext’s LogicalSetData and LogicalGetData methods).</li></ul></li><li><p>thread <code>a</code> invokes thread <code>b</code>, then CLR auto cause thread <code>a</code>‘s execctution context to <code>flow (be copied)</code> to thread <code>b</code>. Also, the <code>Executionontext</code> could be <code>suppress/restore</code> programmingly as following. If thread <code>a</code> suppress flow, then thread <code>b</code> cannot access to thread <code>a</code> context.</p>  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> sealed <span class="class"><span class="keyword">class</span> <span class="title">ExecutionContext</span> :</span> IDisposable, ISerializable</span><br><span class="line">&#123;</span><br><span class="line">    [SecurityCritical] <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AsyncFlowControl <span class="title">SuppressFlow</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">RestoreFlow</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Boolean <span class="title">IsFlowSuppressed</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">// Less commonly used methods are not shown</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h3><span id="cooperative-cancellation-and-timeout">Cooperative Cancellation and Timeout</span></h3><ul><li>.NET fromework offers a standard pattern for canceling operations, is <code>cooperative</code></li><li><p><code>System.Threading.CancellationTokenSource</code>.</p><ul><li><p>the <code>Token</code> is <strong>readonly</strong>, auto-generated on CancellationTokenSource creation.</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">sealed</span> <span class="keyword">class</span> <span class="title">CancellationTokenSource</span> : <span class="title">IDisposable</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CancellationTokenSource</span>(<span class="params"></span>)</span>;</span><br><span class="line">    <span class="keyword">public</span> Boolean IsCancellationRequested &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> CancellationToken Token &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Cancel</span>(<span class="params"></span>)</span>; <span class="comment">// Internally, calls Cancel passing false</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Cancel</span>(<span class="params">Boolean throwOnFirstException</span>)</span>;</span><br><span class="line">    <span class="comment">// other members</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></li><li><p><code>CancellationToken</code> instance is a lightweight value type.</p><ul><li><p>any cancel actions can be <code>Register</code> within token, that can use <code>Dispose</code> to release registered callback from token source.</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">struct</span> CancellationToken</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> CancellationToken None &#123; <span class="keyword">get</span>; &#125; <span class="comment">// Very convenient</span></span><br><span class="line">    <span class="keyword">public</span> Boolean IsCancellationRequested &#123; <span class="keyword">get</span>; &#125; <span class="comment">// Called by non-task invoked operations</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ThrowIfCancellationRequested</span>(<span class="params"></span>)</span>; <span class="comment">// Called by Task-invoked operations</span></span><br><span class="line">    <span class="keyword">public</span> WaitHandle WaitHandle &#123; <span class="keyword">get</span>; &#125; <span class="comment">// WaitHandle is signaled when the CancellationTokenSource is canceled</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CancellationTokenRegistration <span class="title">Register</span>(<span class="params"><span class="comment">/** multiple overloads */</span></span>)</span>;</span><br><span class="line">    <span class="comment">// other members</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></li><li><p><code>CancellationToken’s Register</code> to register callbacks from token source that would be invoked when calling <code>Cancel</code>.</p></li></ul><h3><span id="tasks">Tasks</span></h3><ul><li><p>Task <em>vs</em> ThreadPool</p>  <figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ThreadPool.QueueUserWorkItem(ComputeBoundOp, <span class="number">5</span>); <span class="comment">// Calling QueueUserWorkItem</span></span><br><span class="line"><span class="keyword">new</span> Task(ComputeBoundOp, <span class="number">5</span>).Start(); <span class="comment">// Equivalent of preceding using Task</span></span><br><span class="line">Task.Run(() =&gt; ComputeBoundOp(<span class="number">5</span>)); <span class="comment">// Another equivalent</span></span><br></pre></td></tr></table></figure></li><li><p>Wait for Task Completed/Result</p><ul><li>If the compute-bound task throws an <code>unhandled exception</code>, the exception will be <code>swallowed</code>, stored in a collection, and the thread pool thread is allowed to return to the thread pool. When the <code>Wait</code> method or the <code>Result</code> property is invoked, these members will throw a <code>System.AggregateException</code> object.</li><li>If you <code>never</code> call Wait or Result or query a Task’s Exception property, then your code never observes that this exception has occurred. This is not ideal, because your program has experienced an unexpected problem that you are not aware of. To help you detect unobserved exceptions, you can register a callback method with <code>TaskScheduler’s static UnobservedTaskException</code> event.</li></ul></li><li><p>Cancel a Task</p><ul><li><p>you can use a <code>CancellationTokenSource</code> to cancel a <strong>Task</strong> by creating a task associated a <code>CancellationToken</code> within <em>Task</em>‘s constructor.</p>  <figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// one of a cancellable constructors</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Task</span>(<span class="params">Action action, CancellationToken cancellationToken</span>)</span></span><br></pre></td></tr></table></figure></li><li><p>Task states, as following.</p> <figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">System.Threading.Tasks</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> TaskStatus</span><br><span class="line">    &#123;</span><br><span class="line">        Created = <span class="number">0</span>,    <span class="comment">// Task created explicitly; you can manually Start() this task</span></span><br><span class="line">        WaitingForActivation = <span class="number">1</span>,   <span class="comment">// Task created implicitly; it starts automatically</span></span><br><span class="line">        WaitingToRun = <span class="number">2</span>,   <span class="comment">// The task was scheduled but isn’t running yet</span></span><br><span class="line">        Running = <span class="number">3</span>,    <span class="comment">// The task is actually running</span></span><br><span class="line">        WaitingForChildrenToComplete = <span class="number">4</span>,   <span class="comment">// The task is waiting for children to complete before it considers itself complete</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// A task's final state is one of these:</span></span><br><span class="line">        RanToCompletion = <span class="number">5</span>,</span><br><span class="line">        Canceled = <span class="number">6</span>,</span><br><span class="line">        Faulted = <span class="number">7</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>Only task in Non-Run status (<code>Created / WaitingForActivation / WaitingToRun</code>) can be successfully canceled, otherwise, if the task is started/running (<code>Running</code>), cancel task would throw <code>System.AggregateException</code> exception when calling Wait/Result of Task, and if the task is completed (<code>RanToCompletion</code>/<code>Canceled</code>/<code>Faulted</code>), cancel will take no effects and also throw no exceptions.</p></blockquote></li></ul></li><li><p>ContinueWith another Task</p><ul><li><code>task</code> can be continued with another task, or tasks one by one, in <code>continuationAction</code> can access the pass-in <code>task</code>, continuationAction can also <code>cancelable</code> via <code>CancellationToken</code>, and executes <code>conditionally</code> by <code>TaskContinuationOptions</code>.  <figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sample overload of ContinueWith</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Task <span class="title">ContinueWith</span>(<span class="params">Action&lt;Task&gt; continuationAction, CancellationToken cancellationToken, TaskContinuationOptions continuationOptions, TaskScheduler scheduler</span>)</span>;</span><br></pre></td></tr></table></figure></li></ul></li><li><p>Inside a Task</p><ul><li><code>todo</code></li></ul></li><li><p>Task Factory</p><ul><li><code>todo</code></li></ul></li><li><p>Task Scheduler</p><ul><li><code>todo</code></li></ul></li><li><p><strong>Task.Delay vs Thread.Sleep</strong><br>  <code>Task.Delay</code> will created a Task with status <code>WaitingForActivation</code>, will automatic starts (actually take no actions) to <code>complete</code>, usually <code>ContinueWith</code> another task to execute after delay.</p><ul><li>As it’s a new task, an async task, it would not block current thread. But if Wait() the task, it also block current thread, if use <code>async/await</code> pattern it would non-block current thread and wait for completion.</li><li><p>As it’s <code>WaitingForActivation</code>, it can’t be Start again, it will start automatically.</p><p><code>Thread.Sleep</code> would directly sleep/block current thread for a period of time.</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  create a non-operation async task to complete after 10s delay. status ='WaitingForActivation', it starts automatically, non-block current thread.</span></span><br><span class="line">Task.Delay(<span class="number">10</span> * <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// throw exception 'Start may not be called on a promise-style task.'</span></span><br><span class="line"><span class="comment">// because task status ='WaitingForActivation', task created implicitly; it starts automatically, don't use Start to schedule it again.</span></span><br><span class="line">Task.Delay(<span class="number">10</span> * <span class="number">1000</span>).Start();</span><br><span class="line"></span><br><span class="line"><span class="comment">// wait 10s, block current thread</span></span><br><span class="line">Task.Delay(<span class="number">10</span> * <span class="number">1000</span>).Wait();</span><br><span class="line"></span><br><span class="line"><span class="comment">// wait 10s, but non-block current thread, because of async/await machinism</span></span><br><span class="line"><span class="keyword">await</span> Task.Delay(<span class="number">10</span> * <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// wait/sleep 10s, block current thread</span></span><br><span class="line">Thread.Sleep(<span class="number">10</span> * <span class="number">1000</span>);</span><br></pre></td></tr></table></figure></li></ul></li></ul><h3><span id="parallel">Parallel</span></h3><h2><span id="references">References</span></h2><ul><li>CLR Via C#, 4th Edition, by <code>Jeffrey Richter</code></li><li><a href="http://www.ruanyifeng.com/blog/2013/04/processes_and_threads.html" target="_blank" rel="noopener">进程与线程的一个简单解释</a></li><li><a href="https://social.technet.microsoft.com/wiki/contents/articles/21177.visual-c-thread-sleep-vs-task-delay.aspx" target="_blank" rel="noopener">Visual C#: Thread.Sleep vs. Task.Delay</a></li></ul><h2><span id="about-me">About Me</span></h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> about = &#123;</span><br><span class="line">    name:<span class="string">'xiao-fang'</span>,</span><br><span class="line">    site:<span class="string">'http://xiao-fang.cc'</span>,</span><br><span class="line">    intro: <span class="string">'code to live, live to code...'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;DRAFT VERSION&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;Thread-Basic&quot;&gt;&lt;a href=&quot;#Thread-Basic&quot; class=&quot;headerlink&quot; title=&quot;Thread Basic&quot;&gt;&lt;/a&gt;Thread Basic&lt;/h2&gt;&lt;h3 id=&quot;Background&quot;&gt;&lt;a href=&quot;#Background&quot; class=&quot;headerlink&quot; title=&quot;Background&quot;&gt;&lt;/a&gt;Background&lt;/h3&gt;&lt;p&gt;OS only one &lt;code&gt;Thread&lt;/code&gt; of execution that ran through the entire system.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;includes both OS code/data and application code/data&lt;/li&gt;
&lt;li&gt;exclusive, prevent other tasks from executing&lt;/li&gt;
&lt;li&gt;application may cause infinite loop and block entire OS&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;Process&quot;&gt;&lt;a href=&quot;#Process&quot; class=&quot;headerlink&quot; title=&quot;Process&quot;&gt;&lt;/a&gt;Process&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;each instance of application is a &lt;code&gt;process&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;process&lt;/code&gt; is a collection of resources that’s used by a single instance of application&lt;/li&gt;
&lt;li&gt;virtual address space, isolated domain protection&lt;/li&gt;
&lt;li&gt;depends on and limit to CPU cores&lt;/li&gt;
&lt;li&gt;&lt;code&gt;process&lt;/code&gt; is expensive in Windows, it may take several seconds to create a process (allocate &amp;amp; initialize memory, load exe/dll for disk, etc.)&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="学习笔记" scheme="http://xiao-fang.cc/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
      <category term=".NET" scheme="http://xiao-fang.cc/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/NET/"/>
    
    
      <category term="CLR via C#" scheme="http://xiao-fang.cc/tags/CLR-via-C/"/>
    
      <category term="CLR" scheme="http://xiao-fang.cc/tags/CLR/"/>
    
      <category term="Windows" scheme="http://xiao-fang.cc/tags/Windows/"/>
    
      <category term="Thread" scheme="http://xiao-fang.cc/tags/Thread/"/>
    
  </entry>
  
  <entry>
    <title>How to Install PostgreSQL on CentOS 7?</title>
    <link href="http://xiao-fang.cc/2017/05/11/install-postgresql-on-centos/"/>
    <id>http://xiao-fang.cc/2017/05/11/install-postgresql-on-centos/</id>
    <published>2017-05-11T17:00:00.000Z</published>
    <updated>2020-11-16T01:47:12.577Z</updated>
    
    <content type="html"><![CDATA[<h3><span id="installation">Installation</span></h3><p>CentOS’s default repositories contain Postgres packages, so we can install them without a hassle using the yum package system.</p><h4><span id="install-postgresql-server-and-contrib">Install PostgreSQL server and contrib</span></h4><p>Install the <code>postgresql-server</code> package and the <code>contrib</code> package, that adds some additional utilities and functionality.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo yum install postgresql-server postgresql-contrib -y</span><br></pre></td></tr></table></figure></p><h4><span id="initial-a-postgresql-cluster">Initial a PostgreSQL cluster</span></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo postgresql-setup initdb</span><br></pre></td></tr></table></figure><blockquote><p>Note: that a default PostgreSQL user account would be created during installation, called <code>postgres</code> with the default <code>Postgres</code> role.</p></blockquote><h4><span id="config-host-based-authentication">Config host-based authentication</span></h4><p>By default, PostgreSQL does not allow password authentication. We will change that by editing its host-based authentication (HBA) configuration. open <code>pg_hba.conf</code> with <code>vi</code> or other editors.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vi /var/lib/pgsql/data/pg_hba.conf</span><br></pre></td></tr></table></figure></p><p>Find the lines that looks like this, near the bottom of the file:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#   pg_hba.conf excerpt (original)</span></span><br><span class="line">host    all             all             127.0.0.1/32            ident</span><br><span class="line">host    all             all             ::1/128                 ident</span><br></pre></td></tr></table></figure></p><p>then replace <code>ident</code> with <code>md5</code>, also add one more record <code>host     all     all     0.0.0.0/0       md5</code>, so that the configurations like this:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#   pg_hba.conf excerpt (updated)</span></span><br><span class="line">host    all             all             127.0.0.1/32            md5</span><br><span class="line">host    all             all             ::1/128                 md5</span><br><span class="line">host    all             all             0.0.0.0/0               md5</span><br></pre></td></tr></table></figure></p><h4><span id="enable-start-on-boot-optional">Enable start on boot (<code>optional</code>)</span></h4><p>use <code>systemd</code> to manage the <code>postgresql</code> service to start when the system boots.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo systemctl start postgresql</span><br><span class="line">$ sudo systemctl <span class="built_in">enable</span> postgresql</span><br></pre></td></tr></table></figure></p><p>Then check the status of <code>PostgreSQL</code>, <em>Ready Now ~</em><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># systemctl status postgresql</span><br><span class="line">● postgresql.service - PostgreSQL database server</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/postgresql.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Wed 2017-04-26 10:26:38 CST; 23h ago</span><br><span class="line">  Process: 35747 ExecStop=/usr/bin/pg_ctl stop -D $&#123;PGDATA&#125; -s -m fast (code=exited, status=0/SUCCESS)</span><br><span class="line">  Process: 35754 ExecStart=/usr/bin/pg_ctl start -D $&#123;PGDATA&#125; -s -o -p $&#123;PGPORT&#125; -w -t 300 (code=exited, status=0/SUCCESS)</span><br><span class="line">  Process: 35748 ExecStartPre=/usr/bin/postgresql-check-db-dir $&#123;PGDATA&#125; (code=exited, status=0/SUCCESS)</span><br><span class="line"> Main PID: 35758 (postgres)</span><br><span class="line">   Memory: 12.9M</span><br><span class="line">   CGroup: /system.slice/postgresql.service</span><br><span class="line">           ├─35758 /usr/bin/postgres -D /var/lib/pgsql/data -p 5432</span><br><span class="line">           ├─35759 postgres: logger process</span><br><span class="line">           ├─35761 postgres: checkpointer process</span><br><span class="line">           ├─35762 postgres: writer process</span><br><span class="line">           ├─35763 postgres: wal writer process</span><br><span class="line">           ├─35764 postgres: autovacuum launcher process</span><br><span class="line">           └─35765 postgres: stats collector process</span><br></pre></td></tr></table></figure></p><h4><span id="expose-to-listen-to-ports-optional">Expose to listen to ports (<code>optional</code>)</span></h4><p>Acctually, that the PostgreSQL is ready now. But if external clients cannot connect to the service, it maybe the default <code>5432</code> port not be listen. then edit <code>postgresql.conf</code>.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo cat /var/lib/pgsql/data/postgresql.conf</span><br></pre></td></tr></table></figure></p><p>then change the connection setting <code>listen_addresses</code> from default <code>localhost</code> to <code>*</code>.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ listen_addresses = <span class="string">'*'</span></span><br></pre></td></tr></table></figure></p><p>restart postgres to take effect.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl restart postgresql</span><br></pre></td></tr></table></figure></p><p>Now take a loot at external connection to <code>PostgreSQL</code> via <code>Navicat</code> (or any other tools).<br><img src="/uploads/postgres-navicat.jpg" alt></p><h3><span id="qampa">Q&amp;A</span></h3><p><strong>Q1. what’s the default password for PostgreSQL?</strong><br>There is <code>NO</code> default password for the default created user <code>postgres</code>, because that the default authentication mode for PostgreSQL is <code>Ident</code>. (refer to Q2)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># IPv4 local connections:</span><br><span class="line">host    all              all             127.0.0.1/32             ident</span><br><span class="line"># IPv6 local connections:</span><br><span class="line">host    all              all             ::1/128                  ident</span><br></pre></td></tr></table></figure></p><p>And, as above, <strong><code>config host-based authentication</code></strong> section we can change default <code>Ident</code> authentication mode to <code>host-based authentication</code>. then we’d change the password of default user <code>postgres</code> with <code>psql</code> the <code>\password {POSTGRES_USER}</code> command.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">postgres-<span class="comment"># \password POSTGRES_USER</span></span><br><span class="line">Enter new password:</span><br></pre></td></tr></table></figure></p><p><strong>Q2. what’s the <code>Indent</code> authentication mode for PostgreSQL?</strong><br>It works by taking the OS username now operating as, to compare with the <code>allowed</code> database username(s). <em>This means that in order to connect to PostgreSQL you must be logged in as the correct OS user that allowed in PostgreSQL</em>.</p><p>For example, if you login OS as <code>root</code>, but the <code>root</code> username not allowed in PostgreSQL, that you cannot connect to PostgreSQL, otherwise you can directly connect to it with <code>psql</code>.</p><p>However, it’s available to switch to PostgreSQL users.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -i -u postgres</span><br></pre></td></tr></table></figure></p><p>then you can connect to PostgreSQL with <code>psql</code>.</p><h3><span id="reference">Reference</span></h3><ul><li><p><a href="https://www.digitalocean.com/community/tutorials/how-to-install-and-use-postgresql-on-centos-7" target="_blank" rel="noopener">How To Install and Use PostgreSQL on CentOS 7</a> [from <code>DigitalOcean</code>]</p></li><li><p><a href="https://dba.stackexchange.com/questions/83984/connect-to-postgresql-server-fatal-no-pg-hba-conf-entry-for-host" target="_blank" rel="noopener">connect to PostgreSQL server: FATAL: no pg_hba.conf entry for host</a> [from <code>StackExchange</code>]</p></li><li><p><a href="https://www.liquidweb.com/kb/what-is-the-default-password-for-postgresql/" target="_blank" rel="noopener">What is the Default Password for PostgreSQL?</a></p></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3&gt;&lt;span id=&quot;installation&quot;&gt;Installation&lt;/span&gt;&lt;/h3&gt;&lt;p&gt;CentOS’s default repositories contain Postgres packages, so we can install them witho
      
    
    </summary>
    
      <category term="学习笔记" scheme="http://xiao-fang.cc/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="CentOS" scheme="http://xiao-fang.cc/tags/CentOS/"/>
    
      <category term="PostgreSQL" scheme="http://xiao-fang.cc/tags/PostgreSQL/"/>
    
  </entry>
  
  <entry>
    <title>游天马寨</title>
    <link href="http://xiao-fang.cc/2017/04/30/poem-tianmazhai/"/>
    <id>http://xiao-fang.cc/2017/04/30/poem-tianmazhai/</id>
    <published>2017-04-30T00:00:00.000Z</published>
    <updated>2020-11-16T01:47:12.577Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>公元2017年4月30日, 共伍鹏夫妇, 同游天马寨, 登高赏杜鹃.<br>by 一粟生</p></blockquote><blockquote class="blockquote-center"><br><b>游天马寨</b><br>天马寨头春正好, 人面杜鹃竞妖娆.<br>萧郎不与尔曹随, 故折芦苇吹作箫.<br></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;公元2017年4月30日, 共伍鹏夫妇, 同游天马寨, 登高赏杜鹃.&lt;br&gt;by 一粟生&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote class=&quot;blockquote-center&quot;&gt;&lt;br&gt;&lt;b&gt;游天马寨&lt;/b&gt;&lt;br&gt;天马寨头
      
    
    </summary>
    
      <category term="闲言随笔" scheme="http://xiao-fang.cc/categories/%E9%97%B2%E8%A8%80%E9%9A%8F%E7%AC%94/"/>
    
    
  </entry>
  
  <entry>
    <title>Migrate TFS Project to Git</title>
    <link href="http://xiao-fang.cc/2017/04/27/migrate-tfs-to-git/"/>
    <id>http://xiao-fang.cc/2017/04/27/migrate-tfs-to-git/</id>
    <published>2017-04-27T16:30:00.000Z</published>
    <updated>2020-11-16T01:47:12.577Z</updated>
    
    <content type="html"><![CDATA[<h3><span id="requirements">Requirements</span></h3><ul><li>Git, download <a href="https://git-scm.com/download/win" target="_blank" rel="noopener">Git for Windows</a></li><li>Git-TF, download <a href="https://gittf.codeplex.com/" target="_blank" rel="noopener">Git-TF</a>, add to <code>PATH</code> environment variable</li><li>Java runtime (required by Git-TF), add to <code>PATH</code> environment variable</li><li>Source TFS project to be migrated, here we name it as <code>tfs_project</code></li><li>A git project, here we name it as <code>git_project</code></li></ul><h3><span id="clone-tfs-code">Clone TFS Code</span></h3><p>Firstly, <code>clone</code> source <code>tfs_project</code> to local diretory. <code>git-tf</code> command with the optional <code>--deep</code> flag may be used to clone each TFS changeset for the specified path into the new git repo.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git-tf clone &quot;http://&lt;TFS Server Name&gt;:Port/tfs/&lt;CollectionName&gt; &quot;$/TeamProjectName&quot; –deep</span><br></pre></td></tr></table></figure></p><p>Some errors may happen here:</p><h4><span id="tfs-server-certificate-validation-error">TFS server certificate validation error</span></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git-tf: sun.security.validator.ValidatorException: PKIX path building failed: su</span><br><span class="line">n.security.provider.certpath.SunCertPathBuilderException: unable to find valid c</span><br><span class="line">ertification path to requested target</span><br></pre></td></tr></table></figure><blockquote><p>how to fix:</p></blockquote><p>export TFS server certificate as <code>Base-64 encoded X.509 (.CER)</code> file, then add it to local JRE trust keystore, because <code>Git-TF</code> depends on it.<br>Maybe there’s many version of JRE on your machine, use <code>java -version</code> to check current runtime.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; java -version</span><br><span class="line">java version <span class="string">"1.8.0_111"</span></span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_111-b14)</span><br><span class="line">Java HotSpot(TM) Client VM (build 25.111-b14, mixed mode, sharing)</span><br></pre></td></tr></table></figure><p>then use <code>keytool</code> to add TFS server certificate to <code>keystore</code>.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">C:\Program Files\Java\jre1.8.0_111\bin&gt;keytool -keystore ..\lib\security\cacerts -importcert -file your_servers_cert_file.cer -<span class="built_in">alias</span> tfs-cert</span><br><span class="line">Enter keystore password: changeit</span><br></pre></td></tr></table></figure></p><p><code>Notice that default JRE keystore password is</code> <strong>changeit</strong>.</p><a id="more"></a><h4><span id="unable-to-access-remote-git-due-to-ssl-certificate">Unable to access remote Git due to SSL certificate</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fatal: unable to access &apos;http://&lt;TFS Server Name&gt;:Port/tfs/&lt;CollectionName&gt;/&lt;Team&gt;/_git/&lt;TeamProjectName&gt;/&apos;:</span><br><span class="line">SSL certificate problem: unable to get local issuer certificate</span><br></pre></td></tr></table></figure><blockquote><p>how to fix:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git config --global http.sslVerify false</span><br></pre></td></tr></table></figure></p></blockquote><p><strong> Ok, the <code>tfs_project</code> code are checkout as git repo successfully now ~ </strong></p><h3><span id="commit-as-git-changes">Commit as Git Changes</span></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git commit -a -m <span class="string">'initial commit, migrated from TFS'</span></span><br></pre></td></tr></table></figure><h3><span id="add-git-remote">Add Git Remote</span></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote add origin <span class="string">"http://&lt;TFS Server Name&gt;:Port/tfs/&lt;CollectionName&gt;/&lt;Team&gt;/_git/&lt;TeamProjectName&gt;"</span></span><br></pre></td></tr></table></figure><p>then validate the <code>remote</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote -v</span><br></pre></td></tr></table></figure></p><h3><span id="other-git-actions">Other Git Actions</span></h3><p>Since that the remote TFS source is already migrated to git locally, any other git actions could be taken at anytime ~</p><h3><span id="git-push">Git Push</span></h3><p>Then the changes migrated from TFS could be pushed to git remote. (as above, any git actions as needed)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push origin master -f</span><br></pre></td></tr></table></figure><p><strong>Ok, the <code>git_project</code> is pushed to TFS git successfully now ~</strong></p><p><img src="/uploads/tfs-git.jpeg" alt></p><h3><span id="gitignore-for-net-project"><code>.gitignore</code> for .NET project</span></h3><p>Generally, the source <code>tfs_project</code> may target on .NET platform, maybe Visual Studio project, there is useful <code>.gitignore</code> shared by <a href="https://github.com/github" target="_blank" rel="noopener">Official GitHub</a> on <a href="https://github.com/github/gitignore/blob/master/VisualStudio.gitignore" target="_blank" rel="noopener">visualstudio.ignore</a> for your reference.</p><h3><span id="reference">Reference</span></h3><ul><li><a href="https://gittf.codeplex.com/" target="_blank" rel="noopener">Git-TF</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;Requirements&quot;&gt;&lt;a href=&quot;#Requirements&quot; class=&quot;headerlink&quot; title=&quot;Requirements&quot;&gt;&lt;/a&gt;Requirements&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;Git, download &lt;a href=&quot;https://git-scm.com/download/win&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Git for Windows&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Git-TF, download &lt;a href=&quot;https://gittf.codeplex.com/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Git-TF&lt;/a&gt;, add to &lt;code&gt;PATH&lt;/code&gt; environment variable&lt;/li&gt;
&lt;li&gt;Java runtime (required by Git-TF), add to &lt;code&gt;PATH&lt;/code&gt; environment variable&lt;/li&gt;
&lt;li&gt;Source TFS project to be migrated, here we name it as &lt;code&gt;tfs_project&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;A git project, here we name it as &lt;code&gt;git_project&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;Clone-TFS-Code&quot;&gt;&lt;a href=&quot;#Clone-TFS-Code&quot; class=&quot;headerlink&quot; title=&quot;Clone TFS Code&quot;&gt;&lt;/a&gt;Clone TFS Code&lt;/h3&gt;&lt;p&gt;Firstly, &lt;code&gt;clone&lt;/code&gt; source &lt;code&gt;tfs_project&lt;/code&gt; to local diretory. &lt;code&gt;git-tf&lt;/code&gt; command with the optional &lt;code&gt;--deep&lt;/code&gt; flag may be used to clone each TFS changeset for the specified path into the new git repo.&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;git-tf clone &amp;quot;http://&amp;lt;TFS Server Name&amp;gt;:Port/tfs/&amp;lt;CollectionName&amp;gt; &amp;quot;$/TeamProjectName&amp;quot; –deep&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;Some errors may happen here:&lt;/p&gt;
&lt;h4 id=&quot;TFS-server-certificate-validation-error&quot;&gt;&lt;a href=&quot;#TFS-server-certificate-validation-error&quot; class=&quot;headerlink&quot; title=&quot;TFS server certificate validation error&quot;&gt;&lt;/a&gt;TFS server certificate validation error&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;git-tf: sun.security.validator.ValidatorException: PKIX path building failed: su&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;n.security.provider.certpath.SunCertPathBuilderException: unable to find valid c&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ertification path to requested target&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;how to fix:&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;export TFS server certificate as &lt;code&gt;Base-64 encoded X.509 (.CER)&lt;/code&gt; file, then add it to local JRE trust keystore, because &lt;code&gt;Git-TF&lt;/code&gt; depends on it.&lt;br&gt;Maybe there’s many version of JRE on your machine, use &lt;code&gt;java -version&lt;/code&gt; to check current runtime.&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&amp;gt; java -version&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;java version &lt;span class=&quot;string&quot;&gt;&quot;1.8.0_111&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Java(TM) SE Runtime Environment (build 1.8.0_111-b14)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Java HotSpot(TM) Client VM (build 25.111-b14, mixed mode, sharing)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;then use &lt;code&gt;keytool&lt;/code&gt; to add TFS server certificate to &lt;code&gt;keystore&lt;/code&gt;.&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;C:\Program Files\Java\jre1.8.0_111\bin&amp;gt;keytool -keystore ..\lib\security\cacerts -importcert -file your_servers_cert_file.cer -&lt;span class=&quot;built_in&quot;&gt;alias&lt;/span&gt; tfs-cert&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Enter keystore password: changeit&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;Notice that default JRE keystore password is&lt;/code&gt; &lt;strong&gt;changeit&lt;/strong&gt;.&lt;/p&gt;
    
    </summary>
    
      <category term="拾遗补阙" scheme="http://xiao-fang.cc/categories/%E6%8B%BE%E9%81%97%E8%A1%A5%E9%98%99/"/>
    
    
      <category term="Git" scheme="http://xiao-fang.cc/tags/Git/"/>
    
      <category term="TFS" scheme="http://xiao-fang.cc/tags/TFS/"/>
    
      <category term="Git-TF" scheme="http://xiao-fang.cc/tags/Git-TF/"/>
    
  </entry>
  
  <entry>
    <title>Docker03 - Create a Docker Container</title>
    <link href="http://xiao-fang.cc/2017/04/27/docker03-create-docker-container/"/>
    <id>http://xiao-fang.cc/2017/04/27/docker03-create-docker-container/</id>
    <published>2017-04-27T01:00:00.000Z</published>
    <updated>2020-11-16T01:47:12.577Z</updated>
    
    <content type="html"><![CDATA[<p>Let’s take Docker official example as demo, refer to <a href="https://docs.docker.com/get-started/part2/" target="_blank" rel="noopener">Get Started, Part 2: Containers</a>.<br><em>(demo codes also come from this official post)</em></p><h3><span id="define-a-container-with-a-dockerfile">Define a <code>Container</code> with a <code>Dockerfile</code></span></h3><p>Learn more about <code>Dockerfile</code>, please refer to official wiki.</p><ul><li><a href="https://docs.docker.com/engine/reference/builder/" target="_blank" rel="noopener"><code>Dockerfile</code> Reference</a></li><li><a href="https://docs.docker.com/engine/userguide/eng-image/dockerfile_best-practices/" target="_blank" rel="noopener"><code>Dockerfile</code> Best Practice</a></li></ul><h3><span id="create-an-app-itself">Create an app itself</span></h3><p>As for demo, here is a python web app, getting started with hello world, it contains two files <code>app.py</code> and its <code>requirements.txt</code>.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tree .</span></span><br><span class="line">.</span><br><span class="line">├── app.py</span><br><span class="line">├── Dockerfile</span><br><span class="line">└── requirements.txt</span><br></pre></td></tr></table></figure><h3><span id="build-dockerfile-and-its-app-into-image">Build <code>Dockerfile</code> and its app into <code>Image</code></span></h3><p>then the folder structure of the python-web app is:</p><blockquote><p><code>Dockerfile</code> define/describle how the app could be built into an docker <code>image</code>.</p></blockquote><a id="more"></a><h4><span id="before-a-docker-build">Before a <code>Docker Build</code></span></h4><p>before any docker containers or images created, the <code>docker images -a</code> and <code>docker ps -a</code> list <code>no any image and no any containers</code> also.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># docker ps -a</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br><span class="line"></span><br><span class="line"># docker images</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line"></span><br><span class="line"># cat /var/lib/docker/image/overlay/repositories.json</span><br><span class="line">&#123;&quot;Repositories&quot;:&#123;&#125;&#125;</span><br></pre></td></tr></table></figure><p>At the same time, take a loot at the status of docker lib <code>/var/lib/docker</code>, it seems that there’s nothing under image / containers / swarm.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tree /var/lib/docker/</span></span><br><span class="line">/var/lib/docker/</span><br><span class="line">├── containers</span><br><span class="line">├── image</span><br><span class="line">│   └── overlay</span><br><span class="line">│       ├── distribution</span><br><span class="line">│       │   ├── diffid-by-digest</span><br><span class="line">│       │   │   └── sha256</span><br><span class="line">│       │   │       └── 78445dd45222097f5f8d5a16e48dc19c4ca162dcdb80010ab6f1ccfc7e2c0fa3</span><br><span class="line">│       │   └── v2metadata-by-diffid</span><br><span class="line">│       │       └── sha256</span><br><span class="line">│       ├── imagedb</span><br><span class="line">│       │   ├── content</span><br><span class="line">│       │   │   └── sha256</span><br><span class="line">│       │   └── metadata</span><br><span class="line">│       │       └── sha256</span><br><span class="line">│       ├── layerdb</span><br><span class="line">│       │   ├── mounts</span><br><span class="line">│       │   ├── sha256</span><br><span class="line">│       │   └── tmp</span><br><span class="line">│       └── repositories.json</span><br><span class="line">├── swarm</span><br><span class="line">├── tmp</span><br><span class="line">├── trust</span><br><span class="line">└── volumes</span><br><span class="line">    └── metadata.db</span><br></pre></td></tr></table></figure><h4><span id="build-a-docker-image">Build a Docker Image</span></h4><p>Then build Dockerfile and associated files into <code>image</code> via <code>docker build -t pythonweb .</code>.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ docker build -t pythonweb .</span><br><span class="line"></span><br><span class="line">Sending build context to Docker daemon 4.608 kB</span><br><span class="line">......</span><br><span class="line">Step 7/7 : CMD python app.py</span><br><span class="line"> ---&gt; Running in 363f11978b86</span><br><span class="line"> ---&gt; c55347aa7def</span><br><span class="line">Removing intermediate container 363f11978b86</span><br><span class="line">Successfully built c55347aa7def</span><br></pre></td></tr></table></figure></p><p>Shown as above build log, some <code>intermediate containers</code> were created and then were removed at the end, finally, a new build image with the id <code>c55347aa7def</code> was created.</p><h4><span id="after-a-docker-build">After a <code>Docker Build</code></span></h4><p>Ok, let’s check docker images and containers and document libs again, see what happens after a <code>docker build</code>.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ docker ps -a</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br><span class="line"></span><br><span class="line">$ docker images</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">pythonweb           latest              c55347aa7def        13 minutes ago      194 MB</span><br><span class="line">python              2.7-slim            4a323b466a5a        43 hours ago        182 MB</span><br></pre></td></tr></table></figure></p><p>Shown as above, there are two images <code>pythonweb</code> and <code>python</code>, so the <code>pythonweb</code> is the one we just build, and the <code>python</code> with tag <code>2.7-slim</code> is what our <code>pythonweb</code> depends on and defined in the <code>Dockerfile</code> as following.<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Use an official Python runtime as a base image</span></span><br><span class="line">FROM python:<span class="number">2.7</span>-slim</span><br></pre></td></tr></table></figure></p><p>Then let’s check the docker lib <code>/var/lib/docker/image/overlay/repositories.json</code>, shows docker image repositories.<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># cat /var/lib/docker/image/overlay/repositories.json</span><br><span class="line">&#123;<span class="attr">"Repositories"</span>:&#123;<span class="attr">"python"</span>:&#123;<span class="attr">"python:2.7-slim"</span>:<span class="string">"sha256:4a323b466a5ac4ce65248dd970b538922c54e535700cafe9448b52a3094483ea"</span>,<span class="attr">"python@sha256:2185f75c1dfb1852f04126da57dfe807d608bbebf782f49782009a881c48ab89"</span>:<span class="string">"sha256:4a323b466a5ac4ce65248dd970b538922c54e535700cafe9448b52a3094483ea"</span>&#125;,<span class="attr">"pythonweb"</span>:&#123;<span class="attr">"pythonweb:latest"</span>:<span class="string">"sha256:c55347aa7def1cd290274456f3ce9cadaac68991bc4c40e8868f554476fabe21"</span>&#125;&#125;&#125;</span><br></pre></td></tr></table></figure></p><p>Also, massive directories and files were <code>copied</code> <em>(maybe not that correct, would investigate further later)</em> into <code>/var/lib/docker/overlay/</code> directory…</p><h3><span id="run-the-app">Run the App</span></h3><p>Now a new created/built docker image is ready, let’s run it.</p><p>As the <code>pythonweb</code> app <code>EXPOSE</code> d port <code>80</code> inner, then mapping to local machine (docker engine host machine)’s port, like <code>4000</code>.<br>Firstly check if local port <code>4000</code> is already allocated yet.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -plnt | grep 4000</span><br></pre></td></tr></table></figure><p>then run the app</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 4000:80 pythonweb</span><br></pre></td></tr></table></figure><p>As we can see the <code>pythonweb</code> app is running now ~</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -p 4000:80 pythonweb</span><br><span class="line"> * Running on http://0.0.0.0:80/ (Press CTRL+C to quit)</span><br></pre></td></tr></table></figure><p>Open a browser then visit <code>hostname:4000</code>, here logs the http requests.</p> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">192.168.226.1 - - [27/Apr/2017 00:36:54] &quot;GET / HTTP/1.1&quot; 200 -</span><br><span class="line">192.168.226.1 - - [27/Apr/2017 00:36:54] &quot;GET /favicon.ico HTTP/1.1&quot; 404 -</span><br><span class="line">192.168.226.1 - - [27/Apr/2017 00:37:10] &quot;GET / HTTP/1.1&quot; 200 -</span><br></pre></td></tr></table></figure><p>The browser shows..<br><img src="/uploads/docker03-create-container-01.png" alt></p><p>And also, see what happens to <code>Docker</code> after run an app.</p><ul><li>a new <code>docker container</code> was created with the app’s image, that bind a local port <code>4000</code> to container’s <code>EXPOSE</code> port <code>80</code>.</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker ps -a</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS                  NAMES</span><br><span class="line">050bf22ff4c5        pythonweb           <span class="string">"python app.py"</span>     7 minutes ago       Up 7 minutes        0.0.0.0:4000-&gt;80/tcp   upbeat_rosalind</span><br></pre></td></tr></table></figure><ul><li>then take a look at port <code>4000</code>, listen by a program named <code>docker-proxy</code>.</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@devops edworks]<span class="comment"># netstat -plnt | grep 4000</span></span><br><span class="line">tcp6       0      0 :::4000                 :::*                    LISTEN      61649/docker-proxy</span><br></pre></td></tr></table></figure><ul><li>and a new directory with long-long uuid created under <code>/var/lib/docker/containers/</code>, there are <code>log</code>, <code>checkpoints</code>,<code>config</code>,<code>hostname</code>,<code>hosts</code>,<code>resove.conf</code>,<code>shm</code>, etc.<br>I’d checked the <code>hostname</code> it’s the <code>container-id</code>.</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tree /var/lib/docker/containers/</span></span><br><span class="line">/var/lib/docker/containers/</span><br><span class="line">└── 050bf22ff4c5775fb6904e9ffd035a40af006347ff1e1b6bae5d651d9cc5b12b</span><br><span class="line">    ├── 050bf22ff4c5775fb6904e9ffd035a40af006347ff1e1b6bae5d651d9cc5b12b-json.log</span><br><span class="line">    ├── checkpoints</span><br><span class="line">    ├── config.v2.json</span><br><span class="line">    ├── hostconfig.json</span><br><span class="line">    ├── hostname</span><br><span class="line">    ├── hosts</span><br><span class="line">    ├── resolv.conf</span><br><span class="line">    ├── resolv.conf.hash</span><br><span class="line">    └── shm</span><br></pre></td></tr></table></figure><h4><span id="run-the-app-at-quiet-mode">Run the app at <code>quiet</code> mode</span></h4><p>Let’s go back, when the app started, shows <code>Running on http://0.0.0.0:80/ (Press CTRL+C to quit)</code> as log, so when current session is break/quit, the app would be stopped.</p><ul><li>To start a container in <code>detached</code> mode, you use <code>-d=true</code> or just <code>-d</code> option. By design, containers started in detached mode exit when the root process used to run the container exits</li><li>To reattach to a detached container, use docker attach command.</li><li>Refer to <a href="https://docs.docker.com/engine/reference/run/#detached--d" target="_blank" rel="noopener">Detached (-d)</a></li></ul><h4><span id="stop-start-a-docker-container">Stop / Start a Docker <code>Container</code></span></h4><ul><li>Docker <code>run</code> can always creates a new container.</li><li>Docker <code>start</code> or <code>stop</code> can stop / start an existing container without creating a new.</li><li>References:<ul><li><a href="https://docs.docker.com/engine/reference/commandline/stop/" target="_blank" rel="noopener">docker <code>stop</code></a></li><li><a href="https://docs.docker.com/engine/reference/commandline/start/" target="_blank" rel="noopener">docker <code>start</code></a></li><li><a href="https://docs.docker.com/engine/reference/commandline/run/" target="_blank" rel="noopener">docker <code>run</code></a></li></ul></li></ul><h3><span id="qampa">Q&amp;A</span></h3><blockquote><p>Q: Can the same app run with multiple containers, how to assign the port?<br>A: Yes the same app <code>can</code> run with multiple containers, but should be assigned to <code>different ports</code> if on same docker host machine, otherwise the container<code>would be created but cannot run</code>.</p></blockquote><p>Run the app to bind a allocated port, that Error: <code>failed: port is already allocated.</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -p 4000:80 pythonweb</span><br><span class="line">docker: Error response from daemon: driver failed programming external connectivity on endpoint distracted_knuth (43bd1b6d4140ea22abd7eb5243f9f1573ac6e8ffacd952b23ec16a4c59c63a54): Bind <span class="keyword">for</span> 0.0.0.0:4000 failed: port is already allocated.</span><br></pre></td></tr></table></figure></p><p>Run the app to bind not container’s <code>EXPOSE</code> port, that <code>app running successfully in container, but the app sevice cannot be accesss</code> due to <code>miss-configured EXPOSE d port</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -p 4040:88 pythonweb</span><br><span class="line"> * Running on http://0.0.0.0:80/ (Press CTRL+C to quit)</span><br></pre></td></tr></table></figure></p><blockquote><p><strong> Notice: that even a <code>failed: port is already allocated</code> error happens the <code>container</code> could be also created successfully with the status <code>Created</code>. </strong></p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -p 4000:80 pythonweb</span><br><span class="line">docker: Error response from daemon: driver failed programming external connectivity on endpoint gifted_raman (16eecc637261d89a20be1827aeba135c5472b5b4a0055f2a1c035be5152add38): Bind for 0.0.0.0:4000 failed: port is already allocated.</span><br><span class="line"></span><br><span class="line">$ docker ps -a</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED              STATUS              PORTS                  NAMES</span><br><span class="line">b263cc629e40        pythonweb           &quot;python app.py&quot;     16 seconds ago       Created                                    gifted_raman</span><br></pre></td></tr></table></figure><blockquote><p>Q: If a port already allocated, can the app runs anyway?<br>A: The container would be also created, but it cannot be allocated the port and cannot run. (as above).</p></blockquote><h3><span id="notes">Notes</span></h3><h3><span id="outlines">Outlines:</span></h3><ul><li>Docker01 - Hello, Docker<ul><li>What’s Docker</li><li>What’s Container<ul><li><a href="https://www.docker.com/what-container" target="_blank" rel="noopener">What’s Container</a></li><li><a href="https://containerd.io/" target="_blank" rel="noopener">What’s containerd</a></li><li>Container vs VM</li><li>References</li></ul></li></ul></li><li>Docker02 - Install Docker on CentOS 7</li><li>Docker03 - Create a Docker Container</li><li>Docker04 - Docker Service</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Let’s take Docker official example as demo, refer to &lt;a href=&quot;https://docs.docker.com/get-started/part2/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Get Started, Part 2: Containers&lt;/a&gt;.&lt;br&gt;&lt;em&gt;(demo codes also come from this official post)&lt;/em&gt;&lt;/p&gt;
&lt;h3 id=&quot;Define-a-Container-with-a-Dockerfile&quot;&gt;&lt;a href=&quot;#Define-a-Container-with-a-Dockerfile&quot; class=&quot;headerlink&quot; title=&quot;Define a Container with a Dockerfile&quot;&gt;&lt;/a&gt;Define a &lt;code&gt;Container&lt;/code&gt; with a &lt;code&gt;Dockerfile&lt;/code&gt;&lt;/h3&gt;&lt;p&gt;Learn more about &lt;code&gt;Dockerfile&lt;/code&gt;, please refer to official wiki.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://docs.docker.com/engine/reference/builder/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;&lt;code&gt;Dockerfile&lt;/code&gt; Reference&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://docs.docker.com/engine/userguide/eng-image/dockerfile_best-practices/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;&lt;code&gt;Dockerfile&lt;/code&gt; Best Practice&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;Create-an-app-itself&quot;&gt;&lt;a href=&quot;#Create-an-app-itself&quot; class=&quot;headerlink&quot; title=&quot;Create an app itself&quot;&gt;&lt;/a&gt;Create an app itself&lt;/h3&gt;&lt;p&gt;As for demo, here is a python web app, getting started with hello world, it contains two files &lt;code&gt;app.py&lt;/code&gt; and its &lt;code&gt;requirements.txt&lt;/code&gt;.&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# tree .&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;├── app.py&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;├── Dockerfile&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;└── requirements.txt&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;Build-Dockerfile-and-its-app-into-Image&quot;&gt;&lt;a href=&quot;#Build-Dockerfile-and-its-app-into-Image&quot; class=&quot;headerlink&quot; title=&quot;Build Dockerfile and its app into Image&quot;&gt;&lt;/a&gt;Build &lt;code&gt;Dockerfile&lt;/code&gt; and its app into &lt;code&gt;Image&lt;/code&gt;&lt;/h3&gt;&lt;p&gt;then the folder structure of the python-web app is:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;Dockerfile&lt;/code&gt; define/describle how the app could be built into an docker &lt;code&gt;image&lt;/code&gt;.&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="学习笔记" scheme="http://xiao-fang.cc/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
      <category term="Docker" scheme="http://xiao-fang.cc/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/Docker/"/>
    
    
      <category term="CentOS" scheme="http://xiao-fang.cc/tags/CentOS/"/>
    
      <category term="Docker" scheme="http://xiao-fang.cc/tags/Docker/"/>
    
      <category term="DevOps" scheme="http://xiao-fang.cc/tags/DevOps/"/>
    
      <category term="Linux" scheme="http://xiao-fang.cc/tags/Linux/"/>
    
      <category term="Container" scheme="http://xiao-fang.cc/tags/Container/"/>
    
  </entry>
  
  <entry>
    <title>General Post-Installation Steps for Docker on CentOS</title>
    <link href="http://xiao-fang.cc/2017/04/25/docker-post-install-tips/"/>
    <id>http://xiao-fang.cc/2017/04/25/docker-post-install-tips/</id>
    <published>2017-04-25T16:00:00.000Z</published>
    <updated>2020-11-16T01:47:12.577Z</updated>
    
    <content type="html"><![CDATA[<blockquote class="blockquote-center"><br>Original Post: <a href="https://docs.docker.com/engine/installation/linux/linux-postinstall/" target="_blank" rel="noopener">Post-installation steps for Linux</a><br>by <code>Docker</code><br></blockquote><h3><span id="manage-docker-as-a-non-root-user">Manage Docker as a non-root user</span></h3><ul><li>The docker daemon binds to a Unix socket instead of a TCP port. By default that Unix socket is owned by the user root and other users can only access it using sudo. The docker daemon always runs as the root user.</li><li>If you don’t want to use sudo when you use the docker command, create a Unix group called docker and add users to it. When the docker daemon starts, it makes the ownership of the Unix socket read/writable by the docker group.</li></ul><p>When use docker commands as a non-root (or sudo) role, <code>permission denined</code> as following.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># use docker command as non-root(or equal) role</span><br><span class="line">$ docker images</span><br><span class="line"># Got permission denied while trying to connect to the Docker daemon socket at unix:///var/run/docker.sock: Get http://%2Fvar%2Frun%2Fdocker.sock/v1.27/images/json: dial unix /var/run/docker.sock: connect: permission denied</span><br></pre></td></tr></table></figure></p><blockquote><p><strong>Warning</strong>: The <code>docker</code> group grants privileges equivalent to the <code>root</code> user.</p></blockquote><p>To create the docker group and add your user:</p><ul><li><p>Create the <code>docker</code> group.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo groupadd docker</span><br></pre></td></tr></table></figure></li><li><p>Add your user to the <code>docker</code> group.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo usermod -aG docker YOUR_USER_NAME</span><br></pre></td></tr></table></figure></li><li><p>Log out and log back in so that your group membership is re-evaluated.</p></li><li><p>Verify that you can run <strong>any</strong> <code>docker</code> commands without <code>sudo</code>.</p></li></ul><a id="more"></a><h3><span id="configure-docker-to-start-on-boot">Configure Docker to start on boot</span></h3><blockquote><p>Most current Linux distributions (RHEL, CentOS, Fedora, Ubuntu 16.04 and higher) use <code>systemd</code> to manage which services start when the system boots. Ubuntu 14.10 and below use upstart.</p></blockquote><h4><span id="systemd">systemd</span></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># enable start on boot</span></span><br><span class="line">$ sudo systemctl <span class="built_in">enable</span> docker</span><br><span class="line"><span class="comment"># Created symlink from /etc/systemd/system/multi-user.target.wants/docker.service to /usr/lib/systemd/system/docker.service.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># disable start on boot</span></span><br><span class="line">$ sudo systemctl <span class="built_in">disable</span> docker</span><br><span class="line"><span class="comment"># Removed symlink /etc/systemd/system/multi-user.target.wants/docker.service</span></span><br></pre></td></tr></table></figure><h4><span id="chkconfig">chkconfig</span></h4><p>Use <code>chkconfig</code> to check the config status of <code>Docker</code>.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ chkconfig docker</span><br><span class="line"><span class="comment"># Note: Forwarding request to 'systemctl is-enabled docker.service'.</span></span><br><span class="line"><span class="comment"># enabled</span></span><br></pre></td></tr></table></figure></p><h3><span id="references">References</span></h3><p><a href="https://docs.docker.com/engine/installation/linux/linux-postinstall/" target="_blank" rel="noopener">Post-installation steps for Linux</a><br><a href="https://www.digitalocean.com/community/tutorials/how-to-use-systemctl-to-manage-systemd-services-and-units" target="_blank" rel="noopener">How To Use Systemctl to Manage Systemd Services and Units</a></p>]]></content>
    
    <summary type="html">
    
      &lt;blockquote class=&quot;blockquote-center&quot;&gt;&lt;br&gt;Original Post: &lt;a href=&quot;https://docs.docker.com/engine/installation/linux/linux-postinstall/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Post-installation steps for Linux&lt;/a&gt;&lt;br&gt;by &lt;code&gt;Docker&lt;/code&gt;&lt;br&gt;&lt;/blockquote&gt;

&lt;h3 id=&quot;Manage-Docker-as-a-non-root-user&quot;&gt;&lt;a href=&quot;#Manage-Docker-as-a-non-root-user&quot; class=&quot;headerlink&quot; title=&quot;Manage Docker as a non-root user&quot;&gt;&lt;/a&gt;Manage Docker as a non-root user&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;The docker daemon binds to a Unix socket instead of a TCP port. By default that Unix socket is owned by the user root and other users can only access it using sudo. The docker daemon always runs as the root user.&lt;/li&gt;
&lt;li&gt;If you don’t want to use sudo when you use the docker command, create a Unix group called docker and add users to it. When the docker daemon starts, it makes the ownership of the Unix socket read/writable by the docker group.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;When use docker commands as a non-root (or sudo) role, &lt;code&gt;permission denined&lt;/code&gt; as following.&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;# use docker command as non-root(or equal) role&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ docker images&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# Got permission denied while trying to connect to the Docker daemon socket at unix:///var/run/docker.sock: Get http://%2Fvar%2Frun%2Fdocker.sock/v1.27/images/json: dial unix /var/run/docker.sock: connect: permission denied&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Warning&lt;/strong&gt;: The &lt;code&gt;docker&lt;/code&gt; group grants privileges equivalent to the &lt;code&gt;root&lt;/code&gt; user.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;To create the docker group and add your user:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;Create the &lt;code&gt;docker&lt;/code&gt; group.&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ sudo groupadd docker&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Add your user to the &lt;code&gt;docker&lt;/code&gt; group.&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ sudo usermod -aG docker YOUR_USER_NAME&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Log out and log back in so that your group membership is re-evaluated.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Verify that you can run &lt;strong&gt;any&lt;/strong&gt; &lt;code&gt;docker&lt;/code&gt; commands without &lt;code&gt;sudo&lt;/code&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="学习笔记" scheme="http://xiao-fang.cc/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
      <category term="Docker" scheme="http://xiao-fang.cc/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/Docker/"/>
    
    
      <category term="CentOS" scheme="http://xiao-fang.cc/tags/CentOS/"/>
    
      <category term="Docker" scheme="http://xiao-fang.cc/tags/Docker/"/>
    
      <category term="Docker CE" scheme="http://xiao-fang.cc/tags/Docker-CE/"/>
    
      <category term="DevOps" scheme="http://xiao-fang.cc/tags/DevOps/"/>
    
      <category term="Linux" scheme="http://xiao-fang.cc/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>Install Docker On CentOS 7</title>
    <link href="http://xiao-fang.cc/2017/04/25/install-docker-on-centos-7/"/>
    <id>http://xiao-fang.cc/2017/04/25/install-docker-on-centos-7/</id>
    <published>2017-04-25T14:00:00.000Z</published>
    <updated>2020-11-16T01:47:12.577Z</updated>
    
    <content type="html"><![CDATA[<p>Here are the quick steps to get started with Docker on CentOS, now install <code>Docker CE</code> on <code>CentOS</code> 7.</p><h3><span id="prerequisites">Prerequisites</span></h3><ul><li>64-bit version of CentOS 7</li></ul><h4><span id="update-centos-as-latest">Update CentOs as Latest</span></h4><p>Firstly, update <code>CentOS</code> to latest.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo yum update</span><br></pre></td></tr></table></figure></p><h4><span id="config-web-proxy-on-centos">Config Web Proxy on CentOs</span></h4><p>Sometimes, network connection errors may happen if it’s in Intranet environment, here a web proxy should be configured for yum. Please refer to <a href="http://www.thesysadminhimself.com/2013/08/configuring-web-proxy-on-centos.html" target="_blank" rel="noopener">Configuring Web Proxy on CentOS</a>. <em>[Optional]</em><br>Here it’s only yum should be configured a web proxy for me, as following.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /etc/yum.conf</span></span><br><span class="line">proxy=http://proxy-server-host:port</span><br><span class="line"><span class="comment"># notice: the proxy should NOT be ended with '/'</span></span><br></pre></td></tr></table></figure></p><h4><span id="uninstall-old-versions">Uninstall old Versions</span></h4><p>Older versions of Docker were called <code>docker</code> or <code>docker-engine</code>. If these are installed, uninstall them, along with associated dependencies.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo yum remove docker docker-common container-selinux docker-selinux docker-engine</span><br></pre></td></tr></table></figure></p><h3><span id="install-docker-ce-via-repository">Install Docker CE via Repository</span></h3><h4><span id="install-yum-utils-which-provides-the-yum-config-manager-utility">Install <code>yum-utils</code>, which provides the <code>yum-config-manager</code> utility:</span></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo yum install -y yum-utils</span><br><span class="line">$ sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line">$ sudo yum makecache fast</span><br></pre></td></tr></table></figure><a id="more"></a><h4><span id="install-docker-ce">Install Docker CE</span></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo yum install docker-ce</span><br></pre></td></tr></table></figure><h4><span id="start-docker">Start Docker</span></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo systemctl start docker</span><br></pre></td></tr></table></figure><h4><span id="test-docker-installation">Test Docker installation</span></h4><p>Now verify the docker installation by running a <code>hello-world</code> container.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker run hello-world</span><br></pre></td></tr></table></figure></p><p>Generally, it will show logs as following, that’s a new <code>hello-world</code> image pulled from docker library.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker run hello-world</span><br><span class="line">Unable to find image &apos;hello-world:latest&apos; locally</span><br><span class="line">latest: Pulling from library/hello-world</span><br><span class="line">78445dd45222: Pull complete</span><br><span class="line">Digest: sha256:c5515758d4c5e1e838e9cd307f6c6a0d620b5e07e6f927b07d05f6d12a1ac8d7</span><br><span class="line">Status: Downloaded newer image for hello-world:latest</span><br></pre></td></tr></table></figure></p><p>Then use <code>docker images</code> command to list images, the <code>hello-world</code> image was just downloaded.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker images</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">hello-world         latest              48b5124b2768        3 months ago        1.84 kB</span><br></pre></td></tr></table></figure></p><h3><span id="uninstall-docker">Uninstall Docker</span></h3><blockquote><p>In case of uninstalling docker.</p></blockquote><h4><span id="uninstall-docker-ce-package">Uninstall Docker CE package</span></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo yum remove docker-ce</span><br></pre></td></tr></table></figure><h4><span id="remove-related-resources">Remove related resources</span></h4><ul><li>Images, containers, volumes, or customized configuration files on your host are not automatically removed. To delete all images, containers, and volumes:</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo rm -rf /var/lib/docker</span><br></pre></td></tr></table></figure><ul><li>Any other edited configurations should be deleted manually.</li></ul><h3><span id="reference">Reference</span></h3><ul><li><a href="http://www.thesysadminhimself.com/2013/08/configuring-web-proxy-on-centos.html" target="_blank" rel="noopener">Configuring Web Proxy on CentOS</a></li><li><a href="https://docs.docker.com/engine/installation/linux/centos/" target="_blank" rel="noopener">Get Docker for CentOS</a></li><li><a href="https://store.docker.com/editions/community/docker-ce-server-centos?tab=description" target="_blank" rel="noopener">Docker Community Edition for CentOS</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Here are the quick steps to get started with Docker on CentOS, now install &lt;code&gt;Docker CE&lt;/code&gt; on &lt;code&gt;CentOS&lt;/code&gt; 7.&lt;/p&gt;
&lt;h3 id=&quot;Prerequisites&quot;&gt;&lt;a href=&quot;#Prerequisites&quot; class=&quot;headerlink&quot; title=&quot;Prerequisites&quot;&gt;&lt;/a&gt;Prerequisites&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;64-bit version of CentOS 7&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&quot;Update-CentOs-as-Latest&quot;&gt;&lt;a href=&quot;#Update-CentOs-as-Latest&quot; class=&quot;headerlink&quot; title=&quot;Update CentOs as Latest&quot;&gt;&lt;/a&gt;Update CentOs as Latest&lt;/h4&gt;&lt;p&gt;Firstly, update &lt;code&gt;CentOS&lt;/code&gt; to latest.&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ sudo yum update&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h4 id=&quot;Config-Web-Proxy-on-CentOs&quot;&gt;&lt;a href=&quot;#Config-Web-Proxy-on-CentOs&quot; class=&quot;headerlink&quot; title=&quot;Config Web Proxy on CentOs&quot;&gt;&lt;/a&gt;Config Web Proxy on CentOs&lt;/h4&gt;&lt;p&gt;Sometimes, network connection errors may happen if it’s in Intranet environment, here a web proxy should be configured for yum. Please refer to &lt;a href=&quot;http://www.thesysadminhimself.com/2013/08/configuring-web-proxy-on-centos.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Configuring Web Proxy on CentOS&lt;/a&gt;. &lt;em&gt;[Optional]&lt;/em&gt;&lt;br&gt;Here it’s only yum should be configured a web proxy for me, as following.&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# vi /etc/yum.conf&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;proxy=http://proxy-server-host:port&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# notice: the proxy should NOT be ended with &#39;/&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h4 id=&quot;Uninstall-old-Versions&quot;&gt;&lt;a href=&quot;#Uninstall-old-Versions&quot; class=&quot;headerlink&quot; title=&quot;Uninstall old Versions&quot;&gt;&lt;/a&gt;Uninstall old Versions&lt;/h4&gt;&lt;p&gt;Older versions of Docker were called &lt;code&gt;docker&lt;/code&gt; or &lt;code&gt;docker-engine&lt;/code&gt;. If these are installed, uninstall them, along with associated dependencies.&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ sudo yum remove docker docker-common container-selinux docker-selinux docker-engine&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;Install-Docker-CE-via-Repository&quot;&gt;&lt;a href=&quot;#Install-Docker-CE-via-Repository&quot; class=&quot;headerlink&quot; title=&quot;Install Docker CE via Repository&quot;&gt;&lt;/a&gt;Install Docker CE via Repository&lt;/h3&gt;&lt;h4 id=&quot;Install-yum-utils-which-provides-the-yum-config-manager-utility&quot;&gt;&lt;a href=&quot;#Install-yum-utils-which-provides-the-yum-config-manager-utility&quot; class=&quot;headerlink&quot; title=&quot;Install yum-utils, which provides the yum-config-manager utility:&quot;&gt;&lt;/a&gt;Install &lt;code&gt;yum-utils&lt;/code&gt;, which provides the &lt;code&gt;yum-config-manager&lt;/code&gt; utility:&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ sudo yum install -y yum-utils&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ sudo yum makecache fast&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="学习笔记" scheme="http://xiao-fang.cc/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
      <category term="Docker" scheme="http://xiao-fang.cc/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/Docker/"/>
    
    
      <category term="CentOS" scheme="http://xiao-fang.cc/tags/CentOS/"/>
    
      <category term="Docker" scheme="http://xiao-fang.cc/tags/Docker/"/>
    
      <category term="Docker CE" scheme="http://xiao-fang.cc/tags/Docker-CE/"/>
    
      <category term="DevOps" scheme="http://xiao-fang.cc/tags/DevOps/"/>
    
  </entry>
  
  <entry>
    <title>Live By Love</title>
    <link href="http://xiao-fang.cc/2017/04/08/ee-commings/"/>
    <id>http://xiao-fang.cc/2017/04/08/ee-commings/</id>
    <published>2017-04-08T00:00:00.000Z</published>
    <updated>2020-11-16T01:47:12.577Z</updated>
    
    <content type="html"><![CDATA[<blockquote class="blockquote-center"><br>Trust your heart if the seas catch fire,<br>live by love though the stars walk backward.<br><small>E.E. Cummings</small><br><br>若火生海面, 请相信你的心;<br>尽管星辰陨落, 仍以爱为生.<br></blockquote><p><img src="/uploads/ee-commings.jpg" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote class=&quot;blockquote-center&quot;&gt;&lt;br&gt;Trust your heart if the seas catch fire,&lt;br&gt;live by love though the stars walk backward.&lt;br&gt;&lt;small
      
    
    </summary>
    
      <category term="闲言随笔" scheme="http://xiao-fang.cc/categories/%E9%97%B2%E8%A8%80%E9%9A%8F%E7%AC%94/"/>
    
    
      <category term="Quote" scheme="http://xiao-fang.cc/tags/Quote/"/>
    
  </entry>
  
  <entry>
    <title>春之茶</title>
    <link href="http://xiao-fang.cc/2017/04/04/poem-qing-ming/"/>
    <id>http://xiao-fang.cc/2017/04/04/poem-qing-ming/</id>
    <published>2017-04-04T00:00:00.000Z</published>
    <updated>2020-11-16T01:47:12.577Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>岁在丁酉(2017), 时至清明, 几番春雨后, 新茶初绿, 随笔即景.<br>by 一粟生</p></blockquote><blockquote class="blockquote-center"><br><b>春茶</b><br>春来新绿清明天, 小遁江城有余闲.<br>山环水绕下茶园, 采得春茶换酒钱.<br></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;岁在丁酉(2017), 时至清明, 几番春雨后, 新茶初绿, 随笔即景.&lt;br&gt;by 一粟生&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote class=&quot;blockquote-center&quot;&gt;&lt;br&gt;&lt;b&gt;春茶&lt;/b&gt;&lt;br&gt;春来新绿
      
    
    </summary>
    
      <category term="闲言随笔" scheme="http://xiao-fang.cc/categories/%E9%97%B2%E8%A8%80%E9%9A%8F%E7%AC%94/"/>
    
    
  </entry>
  
</feed>
